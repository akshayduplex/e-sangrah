<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assign Menu</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .menu-container {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 15px;
        }

        .menu-item {
            margin-bottom: 10px;
        }

        .submenu-items {
            margin-left: 30px;
        }

        .form-check-input:checked {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
    </style>
</head>

<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">Assign Menu</h4>
                    </div>
                    <div class="card-body">
                        <form id="assignMenuForm">
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <label for="designation_id" class="form-label">Designation</label>
                                    <select class="form-select" id="designation_id" name="designation_id" required>
                                        <option value="">-- Select Designation --</option>
                                        <% designations.forEach(designation=> { %>
                                            <option value="<%= designation._id %>">
                                                <%= designation.name %>
                                            </option>
                                            <% }); %>
                                    </select>
                                </div>
                                <div class="col-md-6 d-flex align-items-end">
                                    <button type="button" id="btnSelectAll" class="btn btn-outline-primary me-2">
                                        <i class="fas fa-check-square"></i> Select All
                                    </button>
                                    <button type="button" id="btnDeselectAll" class="btn btn-outline-secondary">
                                        <i class="fas fa-times-circle"></i> Deselect All
                                    </button>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-12">
                                    <h5 class="mb-3">Menus</h5>
                                    <div class="menu-container">
                                        <!-- Display all menus in a flat structure if masterMenus is not available -->
                                        <% if (typeof masterMenus !=='undefined' && masterMenus.length> 0) { %>
                                            <% masterMenus.forEach(master=> { %>
                                                <div class="menu-item">
                                                    <div class="form-check">
                                                        <input class="form-check-input master-checkbox" type="checkbox"
                                                            value="<%= master._id %>" id="master_<%= master._id %>">
                                                        <label class="form-check-label fw-bold"
                                                            for="master_<%= master._id %>">
                                                            <%= master.name %>
                                                        </label>
                                                    </div>
                                                </div>
                                                <% }); %>
                                                    <% } %>

                                                        <% if (typeof menuStructure !=='undefined' &&
                                                            menuStructure.length> 0) { %>
                                                            <% menuStructure.forEach(menu=> { %>
                                                                <div class="menu-item">
                                                                    <div class="form-check">
                                                                        <input class="form-check-input menu-checkbox"
                                                                            type="checkbox" value="<%= menu._id %>"
                                                                            id="menu_<%= menu._id %>">
                                                                        <label class="form-check-label fw-bold"
                                                                            for="menu_<%= menu._id %>">
                                                                            <i class="fas fa-folder-open me-1"></i>
                                                                            <%= menu.name %>
                                                                        </label>
                                                                    </div>

                                                                    <% if (menu.children && menu.children.length> 0) {
                                                                        %>
                                                                        <div class="submenu-items">
                                                                            <% menu.children.forEach(submenu=> { %>
                                                                                <div class="menu-item">
                                                                                    <div class="form-check">
                                                                                        <input
                                                                                            class="form-check-input submenu-checkbox"
                                                                                            type="checkbox"
                                                                                            value="<%= submenu._id %>"
                                                                                            id="submenu_<%= submenu._id %>">
                                                                                        <label class="form-check-label"
                                                                                            for="submenu_<%= submenu._id %>">
                                                                                            <i
                                                                                                class="fas fa-file me-1"></i>
                                                                                            <%= submenu.name %>
                                                                                        </label>
                                                                                    </div>
                                                                                </div>
                                                                                <% }); %>
                                                                        </div>
                                                                        <% } %>
                                                                </div>
                                                                <% }); %>
                                                                    <% } else { %>
                                                                        <!-- Fallback: Display all menus in a simple list -->
                                                                        <% menus.forEach(menu=> { %>
                                                                            <div class="menu-item">
                                                                                <div class="form-check">
                                                                                    <input class="form-check-input"
                                                                                        type="checkbox"
                                                                                        value="<%= menu._id %>"
                                                                                        id="menu_<%= menu._id %>">
                                                                                    <label class="form-check-label"
                                                                                        for="menu_<%= menu._id %>">
                                                                                        <% if (menu.type==='Master' ) {
                                                                                            %>
                                                                                            <i
                                                                                                class="fas fa-cubes me-1"></i>
                                                                                            <% } else if
                                                                                                (menu.type==='Menu' ) {
                                                                                                %>
                                                                                                <i
                                                                                                    class="fas fa-folder me-1"></i>
                                                                                                <% } else { %>
                                                                                                    <i
                                                                                                        class="fas fa-file me-1"></i>
                                                                                                    <% } %>
                                                                                                        <%= menu.name %>
                                                                                                            (<%= menu.type
                                                                                                                %>)
                                                                                    </label>
                                                                                </div>
                                                                            </div>
                                                                            <% }); %>
                                                                                <% } %>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-end mt-4">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-1"></i> Save Assignment
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const designationSelect = document.getElementById('designation_id');
            const assignMenuForm = document.getElementById('assignMenuForm');
            const selectAllBtn = document.getElementById('btnSelectAll');
            const deselectAllBtn = document.getElementById('btnDeselectAll');
            const allCheckboxes = document.querySelectorAll('input[type="checkbox"]');

            // Handle designation change
            designationSelect.addEventListener('change', function () {
                const designationId = this.value;

                if (designationId) {
                    // Fetch assigned menus for this designation
                    fetch(`/assign-menu/designation/${designationId}/menus`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Clear all checkboxes first
                                allCheckboxes.forEach(checkbox => {
                                    checkbox.checked = false;
                                });

                                // Check the assigned menus
                                data.data.forEach(menuId => {
                                    const checkbox = document.querySelector(`input[value="${menuId}"]`);
                                    if (checkbox) {
                                        checkbox.checked = true;
                                    }
                                });
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching assigned menus:', error);
                            alert('Error loading assigned menus');
                        });
                } else {
                    // Clear all checkboxes if no designation selected
                    allCheckboxes.forEach(checkbox => {
                        checkbox.checked = false;
                    });
                }
            });

            // Select all button
            selectAllBtn.addEventListener('click', function () {
                allCheckboxes.forEach(checkbox => {
                    checkbox.checked = true;
                });
            });

            // Deselect all button
            deselectAllBtn.addEventListener('click', function () {
                allCheckboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
            });

            // Form submission
            assignMenuForm.addEventListener('submit', function (e) {
                e.preventDefault();

                const designationId = designationSelect.value;
                if (!designationId) {
                    alert('Please select a designation first');
                    return;
                }

                const selectedCheckboxes = document.querySelectorAll('input[type="checkbox"]:checked');
                const menuIds = Array.from(selectedCheckboxes).map(checkbox => checkbox.value);

                // Send assignment to server
                fetch('/assign-menu/assign', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        designation_id: designationId,
                        menu_ids: menuIds
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Menus assigned successfully!');
                        } else {
                            alert('Error: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error assigning menus:', error);
                        alert('Error assigning menus');
                    });
            });
        });
    </script>
</body>

</html>