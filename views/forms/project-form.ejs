<% if (!viewOnly) { %>
    <form id="<%= project ? 'editProjectForm' : 'addProjectForm' %>" enctype="multipart/form-data">
        <% } %>

            <div class="project-details card shadow-sm p-4">

                <!-- Project Name, Code, Type -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label><strong>Project Name</strong></label>
                        <% if (viewOnly) { %>
                            <div>
                                <%= project?.projectName || "N/A" %>
                            </div>
                            <% } else { %>
                                <input type="text" name="projectName" class="form-control"
                                    placeholder="Enter Project Name" value="<%= project?.projectName || '' %>" required>
                                <% } %>
                    </div>

                    <div class="col-md-4">
                        <label><strong>Project Code</strong></label>
                        <% if (viewOnly) { %>
                            <div>
                                <%= project?.projectCode || "N/A" %>
                            </div>
                            <% } else { %>
                                <input type="text" name="projectCode" class="form-control"
                                    placeholder="Enter Project Code" value="<%= project?.projectCode || '' %>"
                                    <%=project ? 'readonly' : '' %> required>
                                <% } %>
                    </div>

                    <div class="col-md-4">
                        <label><strong>Project Type</strong></label>
                        <% if (viewOnly) { %>
                            <div>
                                <%= project?.projectType?.name || "N/A" %>
                            </div>
                            <% } else { %>
                                <select name="projectType" class="form-control select2" required>
                                    <option value="">-- Select Project Type --</option>
                                    <% projectTypes.forEach(pt=> { %>
                                        <option value="<%= pt._id %>"
                                            <%=project?.projectType?._id?.toString()===pt._id.toString() ? "selected"
                                            : "" %>>
                                            <%= pt.name %>
                                        </option>
                                        <% }) %>
                                </select>
                                <% } %>
                    </div>

                </div>

                <!-- Project Manager, Status, Logo -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label><strong>Project Manager</strong></label>
                        <% if (viewOnly) { %>
                            <div>
                                <%= project?.projectManager?.name || "Unassigned" %>
                            </div>
                            <% } else { %>
                                <select name="projectManager" class="form-control select2" required>
                                    <% users.forEach(u=> { %>
                                        <option value="<%= u._id %>"
                                            <%=project?.projectManager?._id?.toString()===u._id.toString() ? "selected"
                                            : "" %>>
                                            <%= u.name %>
                                        </option>
                                        <% }) %>
                                </select>
                                <% } %>
                    </div>

                    <div class="col-md-4">
                        <label><strong>Project Logo</strong></label>
                        <% if (viewOnly) { %>
                            <div>
                                <% if (project?.projectLogo) { %>
                                    <img src="<%= project.projectLogo %>" alt="Logo"
                                        class="img-fluid border rounded bg-light p-1"
                                        style="max-height:50px; object-fit:contain;">
                                    <% } else { %>
                                        N/A
                                        <% } %>
                            </div>
                            <% } else { %>
                                <input type="file" name="projectLogo" class="form-control">
                                <% } %>
                    </div>
                    <div class="col-md-4">
                        <label><strong>Status</strong></label>
                        <% if (viewOnly) { %>
                            <div>
                                <%= project?.projectStatus || "Unknown" %>
                            </div>
                            <% } else { %>
                                <select name="projectStatus" class="form-control select2">
                                    <option value="Active" <%=project?.projectStatus==="Active" ? "selected" : "" %>
                                        >Active</option>
                                    <option value="Inactive" <%=project?.projectStatus==="Inactive" ? "selected" : "" %>
                                        >Inactive</option>
                                    <option value="Closed" <%=project?.projectStatus==="Closed" ? "selected" : "" %>
                                        >Closed</option>
                                </select>
                                <% } %>
                    </div>
                </div>

                <!-- Dates and Duration -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label><strong>Start Date</strong></label>
                        <% if (viewOnly) { %>
                            <div>
                                <%= project?.projectStartDateFormatted || "N/A" %>
                            </div>
                            <% } else { %>
                                <input type="date" name="projectStartDate" class="form-control"
                                    value="<%= project?.projectStartDateISO || '' %>">
                                <% } %>
                    </div>


                    <div class="col-md-4">
                        <label><strong>End Date</strong></label>
                        <% if (viewOnly) { %>
                            <div>
                                <%= project?.projectEndDateFormatted || "N/A" %>
                            </div>
                            <% } else { %>
                                <input type="date" name="projectEndDate" class="form-control"
                                    value="<%= project?.projectEndDateISO || '' %>">
                                <% } %>
                    </div>

                    <div class="col-md-4">
                        <label><strong>Duration (Days)</strong></label>
                        <% if (viewOnly) { %>
                            <div>
                                <%= project?.projectDuration || "N/A" %> Days
                            </div>
                            <% } else { %>
                                <input type="number" name="projectDuration" class="form-control"
                                    value="<%= project?.projectDuration || '' %>" placeholder="Total Days">
                                <% } %>
                    </div>
                </div>

                <!-- Donors, Vendors, Collaboration -->
                <div class="row mb-3">
                    <div class="col-md-12">
                        <label><strong>Donors</strong></label>
                        <% if (viewOnly) { %>
                            <div>
                                <%= (project?.donor || []).map(d=> d.name).join(", ") || "N/A" %>
                            </div>
                            <% } else { %>
                                <select name="donor[]" class="form-control select2" multiple>
                                    <% donors.forEach(d=> { %>
                                        <option value="<%= d._id %>" <%=project?.donor?.some(pd=> pd._id?.toString() ===
                                            d._id.toString()) ? "selected" : "" %>>
                                            <%= d.name %>
                                        </option>
                                        <% }) %>
                                </select>
                                <% } %>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-12">
                        <label><strong>Vendors</strong></label>
                        <% if (viewOnly) { %>
                            <div>
                                <%= (project?.vendor || []).map(v=> v.name).join(", ") || "N/A" %>
                            </div>
                            <% } else { %>
                                <select name="vendor[]" class="form-control select2" multiple>
                                    <% vendors.forEach(v=> { %>
                                        <option value="<%= v._id %>" <%=project?.vendor?.some(pv=> pv._id?.toString()
                                            === v._id.toString()) ? "selected" : "" %>>
                                            <%= v.name %>
                                        </option>
                                        <% }) %>
                                </select>
                                <% } %>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-12">
                        <label><strong>Collaboration Team</strong></label>
                        <% if (viewOnly) { %>
                            <div>
                                <%= (project?.projectCollaborationTeam || []).map(c=> c.name).join(", ") || "N/A" %>
                            </div>
                            <% } else { %>
                                <select name="projectCollaborationTeam[]" class="form-control select2" multiple>
                                    <% users.forEach(u=> { %>
                                        <option value="<%= u._id %>" <%=project?.projectCollaborationTeam?.some(c=>
                                            c._id?.toString() === u._id.toString()) ? "selected" : "" %>>
                                            <%= u.name %>
                                        </option>
                                        <% }) %>
                                </select>
                                <% } %>
                    </div>
                </div>

                <!-- Description -->
                <div class="row mb-3">
                    <div class="col-md-12">
                        <label><strong>Description</strong></label>
                        <% if (viewOnly) { %>
                            <div>
                                <%= project?.projectDescription || "No description available" %>
                            </div>
                            <% } else { %>
                                <textarea name="projectDescription" class="form-control" rows="4"
                                    style="resize:vertical"
                                    placeholder="Enter about Project"><%= project?.projectDescription || '' %></textarea>
                                <% } %>
                    </div>
                </div>

                <% if (!viewOnly) { %>
                    <div class="d-flex justify-content-end">
                        <% if (!project) { %>
                            <a href="/projects" class="btn btn-secondary me-2">Cancel</a>
                            <button type="submit" class="btn btn-primary">Create Project</button>
                            <% } else { %>
                                <button type="button" id="cancelEditBtn" class="btn btn-secondary me-2">Cancel</button>
                                <button type="submit" class="btn btn-primary">Save Changes</button>
                                <% } %>
                    </div>
                    <% } %>
            </div>

            <% if (!viewOnly) { %>
    </form>
    <% } %>