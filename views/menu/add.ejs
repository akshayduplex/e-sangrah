<%- include('../partials/header') %>

    <div class="page-wrapper">
        <div class="content">
            <div class="card-header">
                <h4 class="mb-0">
                    <%= menu ? "Edit Menu" : "Add Menu" %>
                </h4>
            </div>
            <div class="card-body">
                <form id="menuForm">
                    <!-- Type, Master & Name -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <label for="type" class="form-label">Type</label>
                            <select class="form-select" id="type" name="type" required>
                                <option value="">-- Select Type --</option>
                                <option value="dashboard" <%=menu?.type==="dashboard" ? "selected" : "" %>>Dashboard
                                </option>
                                <option value="Master" <%=menu?.type==="Master" ? "selected" : "" %>>Menu</option>
                                <option value="Menu" <%=menu?.type==="Menu" ? "selected" : "" %>>Submenu</option>
                            </select>
                        </div>
                        <div class="col-md-4" id="masterField" style="display: none;">
                            <label for="master_id" class="form-label">Master</label>
                            <select class="form-select" id="master_id" name="master_id">
                                <option value="">-- Select Master --</option>
                                <% masters.forEach(master=> { %>
                                    <option value="<%= master._id %>" <%=menu?.master_id &&
                                        menu.master_id.toString()===master._id.toString() ? "selected" : "" %>>
                                        <%= master.name %>
                                    </option>
                                    <% }) %>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="name" class="form-label">Name</label>
                            <input type="text" class="form-control" id="name" name="name" placeholder="Enter Name"
                                value="<%= menu?.name || "" %>" required>
                        </div>
                    </div>

                    <!-- Icon, URL, Priority -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <label for="icon_code" class="form-label">Icon Code</label>
                            <input type="text" class="form-control" id="icon_code" name="icon_code"
                                placeholder="Enter Icon Code" value="<%= menu?.icon_code || '' %>">
                        </div>
                        <div class="col-md-4">
                            <label for="url" class="form-label">URL</label>
                            <input type="text" class="form-control" id="url" name="url" placeholder="Enter URL"
                                value="<%= menu?.url || '' %>">
                        </div>
                        <div class="col-md-4">
                            <label for="priority" class="form-label">Priority</label>
                            <input type="number" class="form-control" id="priority" name="priority"
                                placeholder="Enter Priority" value="<%= menu?.priority || 1 %>" required min="1">
                        </div>
                    </div>

                    <!-- Is Show -->
                    <div class="row mb-4">
                        <div class="col-md-12 d-flex align-items-center">
                            <label class="form-label me-3 mb-0">Is Active</label>
                            <div class="btn-group" role="group" aria-label="Is Show">
                                <input type="radio" class="btn-check" name="is_show" id="is_show_yes" value="true"
                                    autocomplete="off" <%=menu?.is_show !==false ? "checked" : "" %>>
                                <label class="btn btn-outline-secondary" for="is_show_yes"><i class="fas fa-eye"></i>
                                    Yes</label>

                                <input type="radio" class="btn-check" name="is_show" id="is_show_no" value="false"
                                    autocomplete="off" <%=menu?.is_show===false ? "checked" : "" %>>
                                <label class="btn btn-outline-secondary" for="is_show_no"><i
                                        class="fas fa-eye-slash"></i> No</label>
                            </div>
                        </div>
                    </div>

                    <!-- Buttons -->
                    <div class="d-flex justify-content-end mt-4">
                        <a href="/menu/list" class="btn btn-secondary me-2">Cancel</a>
                        <button type="submit" class="btn btn-primary">
                            <%= menu ? "Save Changes" : "Submit" %>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <%- include('../partials/footer') %>

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const typeSelect = document.getElementById("type");
                const masterField = document.getElementById("masterField");
                const masterSelect = document.getElementById("master_id");
                const form = document.getElementById("menuForm");

                function toggleMasterField() {
                    if (typeSelect.value === "Menu") {
                        masterField.style.display = "block";
                        masterSelect.disabled = false;
                    } else {
                        masterField.style.display = "none";
                        masterSelect.value = "";
                        masterSelect.disabled = true;
                    }
                }

                typeSelect.addEventListener("change", toggleMasterField);
                toggleMasterField(); // run on load

                form.addEventListener("submit", async function (e) {
                    e.preventDefault();
                    const formData = new FormData(form);
                    const data = Object.fromEntries(formData.entries());

                    const url = "<%= menu ? `/api/menu/${menu._id}` : '/api/menu' %>";
                    const method = "<%= menu ? 'PUT' : 'POST' %>";

                    try {
                        const response = await fetch(url, {
                            method: method,
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(data)
                        });

                        const result = await response.json();

                        if (result.success) {
                            showSuccess("<%= menu ? 'Menu updated successfully' : 'Menu added successfully' %>");
                            setTimeout(() => {
                                window.location.href = "/menu/list";
                            }, 1500);
                        } else {
                            showError(result.message || "Something went wrong");
                        }
                    } catch (err) {
                        console.error(err);
                        showError(err.message || "An error occurred");
                    }
                });
            });
        </script>