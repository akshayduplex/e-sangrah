<%- include('../partials/header') %>

    <!-- Page Wrapper -->
    <div class="page-wrapper">
        <div class="content">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h4 class="mb-0">Assign Menu</h4>
                        </div>
                        <div class="card-body">
                            <form id="assignMenuForm">
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <label for="designation_id" class="form-label">Designation</label>
                                        <select class="form-select" id="designation_id" name="designation_id" required>
                                            <option value="">-- Select Designation --</option>
                                            <% designations.forEach(designation=> { %>
                                                <option value="<%= designation._id %>">
                                                    <%= designation.name %>
                                                </option>
                                                <% }); %>
                                        </select>
                                    </div>
                                    <div class="col-md-6 d-flex align-items-end">
                                        <button type="button" id="btnSelectAll" class="btn btn-outline-primary me-2">
                                            <i class="fas fa-check-square"></i> Select All
                                        </button>
                                        <button type="button" id="btnDeselectAll" class="btn btn-outline-secondary">
                                            <i class="fas fa-times-circle"></i> Deselect All
                                        </button>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-12">
                                        <h5 class="mb-3">Menus</h5>
                                        <div class="menu-container">
                                            <!-- Display all menus in a flat structure if masterMenus is not available -->
                                            <% if (typeof masterMenus !=='undefined' && masterMenus.length> 0) { %>
                                                <% masterMenus.forEach(master=> { %>
                                                    <div class="menu-item">
                                                        <div class="form-check">
                                                            <input class="form-check-input master-checkbox"
                                                                type="checkbox" value="<%= master._id %>"
                                                                id="master_<%= master._id %>">
                                                            <label class="form-check-label fw-bold"
                                                                for="master_<%= master._id %>">
                                                                <%= master.name %>
                                                            </label>
                                                        </div>
                                                    </div>
                                                    <% }); %>
                                                        <% } %>

                                                            <% if (typeof menuStructure !=='undefined' &&
                                                                menuStructure.length> 0) { %>
                                                                <% menuStructure.forEach(menu=> { %>
                                                                    <div class="menu-item">
                                                                        <div class="form-check">
                                                                            <input
                                                                                class="form-check-input menu-checkbox"
                                                                                type="checkbox" value="<%= menu._id %>"
                                                                                id="menu_<%= menu._id %>">
                                                                            <label class="form-check-label fw-bold"
                                                                                for="menu_<%= menu._id %>">
                                                                                <i class="fas fa-folder-open me-1"></i>
                                                                                <%= menu.name %>
                                                                            </label>
                                                                        </div>

                                                                        <% if (menu.children && menu.children.length> 0)
                                                                            {
                                                                            %>
                                                                            <div class="submenu-items">
                                                                                <% menu.children.forEach(submenu=> { %>
                                                                                    <div class="menu-item">
                                                                                        <div class="form-check">
                                                                                            <input
                                                                                                class="form-check-input submenu-checkbox"
                                                                                                type="checkbox"
                                                                                                value="<%= submenu._id %>"
                                                                                                id="submenu_<%= submenu._id %>">
                                                                                            <label
                                                                                                class="form-check-label"
                                                                                                for="submenu_<%= submenu._id %>">
                                                                                                <i
                                                                                                    class="fas fa-file me-1"></i>
                                                                                                <%= submenu.name %>
                                                                                            </label>
                                                                                        </div>
                                                                                    </div>
                                                                                    <% }); %>
                                                                            </div>
                                                                            <% } %>
                                                                    </div>
                                                                    <% }); %>
                                                                        <% } else { %>
                                                                            <!-- Fallback: Display all menus in a simple list -->
                                                                            <% menus.forEach(menu=> { %>
                                                                                <div class="menu-item">
                                                                                    <div class="form-check">
                                                                                        <input class="form-check-input"
                                                                                            type="checkbox"
                                                                                            value="<%= menu._id %>"
                                                                                            id="menu_<%= menu._id %>">
                                                                                        <label class="form-check-label"
                                                                                            for="menu_<%= menu._id %>">
                                                                                            <% if (menu.type==='Master'
                                                                                                ) { %>
                                                                                                <i
                                                                                                    class="fas fa-cubes me-1"></i>
                                                                                                <% } else if
                                                                                                    (menu.type==='Menu'
                                                                                                    ) { %>
                                                                                                    <i
                                                                                                        class="fas fa-folder me-1"></i>
                                                                                                    <% } else { %>
                                                                                                        <i
                                                                                                            class="fas fa-file me-1"></i>
                                                                                                        <% } %>
                                                                                                            <%= menu.name
                                                                                                                %>
                                                                                                                (<%= menu.type
                                                                                                                    %>)
                                                                                        </label>
                                                                                    </div>
                                                                                </div>
                                                                                <% }); %>
                                                                                    <% } %>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-end mt-4">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-1"></i> Save Assignment
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <%- include('../partials/footer') %>
            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    const designationSelect = document.getElementById('designation_id');
                    const assignMenuForm = document.getElementById('assignMenuForm');
                    const selectAllBtn = document.getElementById('btnSelectAll');
                    const deselectAllBtn = document.getElementById('btnDeselectAll');
                    const allCheckboxes = document.querySelectorAll('input[type="checkbox"]');

                    let assignedMenus = []; // store menus already assigned

                    // --- Load assigned menus when designation changes ---
                    designationSelect.addEventListener('change', function () {
                        const designationId = this.value;
                        if (!designationId) {
                            allCheckboxes.forEach(cb => cb.checked = false);
                            assignedMenus = [];
                            return;
                        }

                        fetch(`/api/assign-menu/designation/${designationId}/menus`)
                            .then(res => res.json())
                            .then(data => {
                                allCheckboxes.forEach(cb => cb.checked = false);
                                assignedMenus = data.success ? data.data : [];
                                // Pre-check already assigned menus
                                assignedMenus.forEach(menuId => {
                                    const cb = document.querySelector(`input[value="${menuId}"]`);
                                    if (cb) cb.checked = true;
                                });
                            })
                            .catch(err => console.error('Error fetching assigned menus:', err));
                    });

                    // --- Select All menus and assign in bulk ---
                    selectAllBtn.addEventListener('click', function () {
                        const designationId = designationSelect.value;
                        if (!designationId) return alert('Please select a designation first.');

                        const menuIds = Array.from(allCheckboxes).map(cb => cb.value);

                        if (menuIds.length === 0) return alert('No menus available to assign.');

                        fetch('/api/assign-menu/assign', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ designation_id: designationId, menu_ids: menuIds })
                        })
                            .then(res => res.json())
                            .then(data => {
                                if (data.success) {
                                    allCheckboxes.forEach(cb => cb.checked = true);
                                    assignedMenus = menuIds.slice(); // update assigned menus
                                    alert('All menus assigned successfully!');
                                } else {
                                    alert('Error: ' + data.message);
                                }
                            })
                            .catch(err => {
                                console.error('Error assigning all menus:', err);
                                alert('Error assigning menus.');
                            });
                    });

                    // --- Deselect All menus and unassign in bulk ---
                    deselectAllBtn.addEventListener('click', function () {
                        const designationId = designationSelect.value;
                        if (!designationId) return alert('Please select a designation first.');

                        const checkedCheckboxes = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'));
                        const menuIds = checkedCheckboxes.map(cb => cb.value);

                        if (menuIds.length === 0) return alert('No menus are currently selected.');

                        fetch('/api/assign-menu/unselect', {
                            method: 'DELETE',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ designation_id: designationId, menu_ids: menuIds })
                        })
                            .then(res => res.json())
                            .then(data => {
                                if (data.deletedCount > 0) {
                                    checkedCheckboxes.forEach(cb => cb.checked = false);
                                    assignedMenus = assignedMenus.filter(id => !menuIds.includes(id));
                                    alert('Selected menus have been unassigned successfully.');
                                } else {
                                    alert('No menus were unassigned.');
                                }
                            })
                            .catch(err => {
                                console.error('Error unassigning menus:', err);
                                alert('Error unassigning menus.');
                            });
                    });

                    // --- Form submission for assigning selected menus ---
                    assignMenuForm.addEventListener('submit', function (e) {
                        e.preventDefault();
                        const designationId = designationSelect.value;
                        if (!designationId) return alert('Please select a designation first.');

                        const selectedCheckboxes = document.querySelectorAll('input[type="checkbox"]:checked');
                        const menuIds = Array.from(selectedCheckboxes).map(cb => cb.value);

                        // Only assign menus that are not already assigned
                        const newMenuIds = menuIds.filter(id => !assignedMenus.includes(id));
                        if (newMenuIds.length === 0) return alert('No new menus to assign.');

                        fetch('/api/assign-menu/assign', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ designation_id: designationId, menu_ids: newMenuIds })
                        })
                            .then(res => res.json())
                            .then(data => {
                                if (data.success) {
                                    assignedMenus = assignedMenus.concat(newMenuIds); // update assigned menus
                                    alert('Menus assigned successfully!');
                                } else {
                                    alert('Error: ' + data.message);
                                }
                            })
                            .catch(err => {
                                console.error('Error assigning menus:', err);
                                alert('Error assigning menus.');
                            });
                    });
                });
            </script>