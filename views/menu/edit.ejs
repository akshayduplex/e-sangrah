<%- include('../partials/header') %>

    <div class="page-wrapper">
        <div class="content">
            <div class="row">
                <div class="col-6 offset-3">
                    <div class="card">
                        <div class="card-header">
                            <h4>Edit Menu</h4>
                        </div>
                        <div class="card-body">
                            <form action="/api/menu/<%= menu._id %>?_method=PUT" method="POST" id="editMenuForm">
                                <input type="hidden" name="_method" value="PUT">
                                <div class="mb-3">
                                    <label for="type" class="form-label">Type</label>
                                    <select class="form-select" id="type" name="type" required>
                                        <option value="Master" <%=menu.type==="Master" ? "selected" : "" %>>Master
                                        </option>
                                        <option value="Menu" <%=menu.type==="Menu" ? "selected" : "" %>>Menu</option>
                                    </select>
                                </div>

                                <!-- Master selection (only for Menu) -->
                                <div class="mb-3" id="masterField" style="display:none;">
                                    <label for="master_id" class="form-label">Master</label>
                                    <select class="form-select" id="master_id" name="master_id">
                                        <option value="">-- Select Master --</option>
                                        <% masters.forEach(master=> { %>
                                            <option value="<%= master._id %>" <%=menu.master_id &&
                                                menu.master_id.toString()===master._id.toString() ? "selected" : "" %>>
                                                <%= master.name %>
                                            </option>
                                            <% }) %>
                                    </select>
                                </div>

                                <!-- Name -->
                                <div class="mb-3">
                                    <label for="name" class="form-label">Name</label>
                                    <input type="text" class="form-control" id="name" name="name"
                                        value="<%= menu.name %>" required>
                                </div>

                                <!-- Icon & URL -->
                                <div class="mb-3">
                                    <label for="icon_code" class="form-label">Icon Code</label>
                                    <input type="text" class="form-control" id="icon_code" name="icon_code"
                                        value="<%= menu.icon_code || '' %>">
                                </div>
                                <div class="mb-3">
                                    <label for="url" class="form-label">URL</label>
                                    <input type="text" class="form-control" id="url" name="url"
                                        value="<%= menu.url || '' %>">
                                </div>

                                <!-- Priority -->
                                <div class="mb-3">
                                    <label for="priority" class="form-label">Priority</label>
                                    <input type="number" class="form-control" id="priority" name="priority"
                                        value="<%= menu.priority %>" required min="1">
                                </div>

                                <!-- Is Show -->
                                <div class="mb-3">
                                    <label for="is_show" class="form-label">Is Active</label>
                                    <select class="form-select" id="is_show" name="is_show" required>
                                        <option value="true" <%=menu.is_show ? "selected" : "" %>>Yes</option>
                                        <option value="false" <%=!menu.is_show ? "selected" : "" %>>No</option>
                                    </select>
                                </div>

                                <!-- Buttons -->
                                <div class="d-flex justify-content-end">
                                    <a href="/menu/list" class="btn btn-secondary me-2">Cancel</a>
                                    <button type="submit" class="btn btn-primary">Save Changes</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <%- include('../partials/footer') %>

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const typeSelect = document.getElementById("type");
                const masterField = document.getElementById("masterField");
                const masterSelect = document.getElementById("master_id");
                const form = document.getElementById("editMenuForm");

                function toggleMasterField() {
                    if (typeSelect.value === "Menu") {
                        masterField.style.display = "block";
                        masterSelect.disabled = false;
                    } else {
                        masterField.style.display = "none";
                        masterSelect.value = "";
                        masterSelect.disabled = true;
                    }
                }

                typeSelect.addEventListener("change", toggleMasterField);
                toggleMasterField(); // run once on load

                // Handle form submission
                form.addEventListener("submit", async function (e) {
                    e.preventDefault(); // prevent default form submission

                    const formData = new FormData(form);
                    const data = Object.fromEntries(formData.entries());

                    try {
                        const response = await fetch(form.action, {
                            method: "PUT",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify(data)
                        });

                        if (response.ok) {
                            showSuccess("Menu updated successfully!");
                            setTimeout(() => {
                                window.location.href = "/menu/list";
                            }, 1500); // redirect after 1.5s
                        } else {
                            const error = await response.json();
                            showError(error.message || "Failed to update menu");
                        }
                    } catch (err) {
                        showError(err.message);
                    }
                });
            });
        </script>