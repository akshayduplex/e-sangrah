<%- include('../partials/header') %>

	<!-- Page Wrapper -->
	<div class="page-wrapper">
		<div class="content">
			<!-- Breadcrumb -->
			<div class="d-md-flex d-block align-items-center justify-content-between page-breadcrumb mb-3">
				<div class="my-auto mb-2">
					<h2 class="mb-1">
						<%= isEdit ? "Edit Document" : "Add Document" %>
					</h2>
					<nav>
						<ol class="breadcrumb mb-0">
							<li class="breadcrumb-item"><a href="#"><i class="ti ti-smart-home"></i></a></li>
							<li class="breadcrumb-item">
								<%= isEdit ? "Edit Document" : "Add Document" %>
							</li>
						</ol>
					</nav>
				</div>
			</div>
			<!-- /Breadcrumb -->

			<div class="add-info-fieldset">
				<form id="documentForm" action="<%= isEdit ? '/api/documents/' + document._id : '/api/documents' %>"
					method="POST" enctype="multipart/form-data">
					<% if (isEdit) { %>
						<input type="hidden" name="_method" value="PATCH">
						<% } %>


							<div class="modal-body">
								<div class="row">
									<!-- Project Name -->
									<div class="col-md-4">
										<div class="mb-3">
											<label class="form-label">Project Name</label>
											<select id="projectName" name="projectName" class="form-select select2"
												required>
												<option value="">-- Select Project Name --</option>
												<% if (projectNames && projectNames.length) { %>
													<% projectNames.forEach(project=> { %>
														<option value="<%= project._id %>" <%=isEdit && document.project
															&& document.project._id.toString()===project._id.toString()
															? "selected" : "" %>>
															<%= project.projectName %>
														</option>
														<% }) %>
															<% } else { %>
																<option disabled>No projects available</option>
																<% } %>
											</select>
										</div>
									</div>

									<!-- Department -->
									<div class="col-md-4">
										<div class="mb-3">
											<label class="form-label">Department <span
													class="text-danger">*</span></label>
											<select id="department" name="department" class="form-select select2"
												required>
												<option value="">-- Select Department --</option>
												<% if (departments && departments.length) { %>
													<% departments.forEach(dep=> { %>
														<option value="<%= dep._id %>" <%=isEdit && document.department
															&& document.department.toString()===dep._id.toString()
															? "selected" : "" %>>
															<%= dep.name %>
														</option>
														<% }) %>
															<% } else { %>
																<option disabled>No departments available</option>
																<% } %>
											</select>
										</div>
									</div>

									<!-- Project Manager -->
									<div class="col-md-4">
										<div class="mb-3">
											<label class="form-label">Project Manager</label>
											<select id="projectManager" name="projectManager"
												class="form-select select2" required>
												<option value="">-- Select Project Manager --</option>
												<% if (users && users.length) { %>
													<% users.forEach(user=> { %>
														<option value="<%= user._id %>" <%=isEdit &&
															document.projectManager &&
															document.projectManager.toString()===user._id.toString()
															? "selected" : "" %>>
															<%= user.name %>
														</option>
														<% }) %>
															<% } else { %>
																<option disabled>No users available</option>
																<% } %>
											</select>
										</div>
									</div>

									<!-- Document Date -->
									<div class="col-md-4">
										<div class="mb-3">
											<label class="form-label">Select Date</label>
											<div class="input-icon-end position-relative">
												<input type="text" name="documentDate"
													class="form-control datetimepicker" placeholder="dd/mm/yyyy"
													value="<%= isEdit && document.documentDate ? new Date(document.documentDate).toLocaleDateString('en-GB') : '' %>"
													required>
												<span class="input-icon-addon"><i
														class="ti ti-calendar text-gray-7"></i></span>
											</div>
										</div>
									</div>

									<!-- Tags -->
									<div class="col-md-4">
										<div class="mb-3">
											<label class="form-label">Add Tags (comma separated)</label>
											<input type="text" name="tags" class="form-control"
												placeholder="tag1, tag2, tag3"
												value="<%= isEdit && document.tags ? document.tags.join(', ') : '' %>">
										</div>
									</div>

									<!-- Metadata -->
									<div class="col-md-4">
										<div class="mb-3">
											<label class="form-label">Meta Data</label>
											<div class="position-relative">
												<input type="text" id="metadataDisplay" class="form-control" readonly
													value="<%= isEdit && document.metadata ? document.metadata.fileName + ' - ' + document.metadata.fileDescription : '' %>">
												<input type="hidden" id="metadataInput" name="metadata"
													value="<%= isEdit && document.metadata ? JSON.stringify(document.metadata) : '' %>">
												<button type="button" class="border-0 fieldright_btn"
													data-bs-toggle="modal" data-bs-target="#metadata-modal">
													<img src="/img/icons/fieldbtn.png">
												</button>
											</div>
										</div>
									</div>

									<!-- Description -->
									<div class="col-md-12">
										<div class="mb-3">
											<label class="form-label">Description</label>
											<textarea id="summernote" name="description"
												style="display: none;"><%= isEdit && document.description ? document.description : '' %></textarea>
											<div class="summernote">
												<%= isEdit && document.description ? document.description : '' %>
											</div>
										</div>
									</div>

									<!-- Compliance -->
									<div class="col-md-6">
										<div class="mb-3">
											<div class="d-flex align-items-center gap-5">
												<label class="form-label mb-0">Compliance and Retention Document</label>
												<div class="form-check">
													<input class="form-check-input" type="radio" name="compliance"
														value="yes" id="complianceYes" <%=isEdit &&
														document.compliance==='yes' ? 'checked' : '' %>>
													<label class="form-check-label" for="complianceYes">Yes</label>
												</div>
												<div class="form-check">
													<input class="form-check-input" type="radio" name="compliance"
														id="complianceNo" value="no" <%=!isEdit ||
														document.compliance==='no' ? 'checked' : '' %>>
													<label class="form-check-label" for="complianceNo">No</label>
												</div>
											</div>
										</div>
									</div>

									<!-- Expiry Date -->
									<div class="col-md-6" id="expiryDateContainer"
										style="display: <%= isEdit && document.compliance === 'yes' ? 'block' : 'none' %>;">
										<div class="mb-3">
											<div class="d-flex align-items-center gap-5">
												<label class="form-label mb-0">Enter Expiry Date</label>
												<div class="input-icon-end position-relative">
													<input type="text" class="form-control datetimepicker"
														name="expiryDate" placeholder="dd/mm/yyyy"
														value="<%= isEdit && document.expiryDate ? new Date(document.expiryDate).toLocaleDateString('en-GB') : '' %>"
														<%=isEdit && document.compliance==='yes' ? 'required' : '' %>>
													<span class="input-icon-addon"><i
															class="ti ti-calendar text-gray-7"></i></span>
												</div>
											</div>
										</div>
									</div>

									<!-- Comment -->
									<div class="col-md-12">
										<div class="mb-3">
											<label class="form-label">Leave a comment (Optional)</label>
											<input type="text" class="form-control" name="comment"
												value="<%= isEdit && document.comment ? document.comment : '' %>">
										</div>
									</div>

									<!-- File Upload -->
									<div class="col-md-12">
										<label class="form-label">File Uploads</label>
										<div class="upload-box mb-3" id="uploadBox">
											<i class="ti ti-cloud-upload fa-2x text-primary mb-2"></i>
											<p class="mb-1"><strong>Click to upload file</strong> or drag and drop</p>
											<small class="text-muted">Max 10GB total storage. DOCX / PPTX / CSV /
												PDF</small>
											<input type="file" class="form-control d-none" id="fileInput" name="files"
												multiple <%=!isEdit ? 'required' : '' %>>
										</div>

										<% if (!isEdit) { %>
											<div class="crtfoldr_row text-center my-4">
												<span class="pe-3">or</span>
												<button type="button" class="btn btn-primary rounded-pill"
													data-bs-toggle="modal" data-bs-target="#folder-modal">Create
													Folder</button>
											</div>
											<% } %>

												<div id="fileList">
													<% if (isEdit && document.files && document.files.length) { %>
														<% document.files.forEach(file=> { %>
															<div class="file-item col-sm-5 mb-3 p-3 border rounded"
																data-file-id="<%= file._id %>">
																<div class="file-info d-flex align-items-center">
																	<i class="fa-solid fa-file fa-2x me-3"></i>
																	<div class="flex-grow-1">
																		<h6 class="mb-0 text-truncate">
																			<%= file.originalName %>
																		</h6>
																		<small class="text-muted">
																			<%= (file.size / 1024 / 1024).toFixed(2) %>
																				MB
																		</small>
																	</div>
																</div>
																<div class="file-progress mt-2">
																	<div class="progress">
																		<div class="progress-bar bg-success"
																			role="progressbar" style="width: 100%">
																			Uploaded</div>
																	</div>
																</div>
																<a href="<%= file.url || '/uploads/' + file.filename %>"
																	target="_blank"
																	class="btn btn-sm btn-info mt-2 me-2">
																	<i class="fa-solid fa-eye"></i> View
																</a>
																<button class="remove-btn btn btn-sm btn-danger mt-2"
																	data-file-id="<%= file._id %>">
																	<i class="fa-solid fa-xmark"></i> Remove
																</button>
															</div>
															<% }) %>
																<% } %>
												</div>
									</div>

									<!-- Signature -->
									<div class="col-md-12">
										<label class="form-label">Add Your Signature</label>
										<div class="signtrboxwrp mb-3">
											<div class="signbox form-control" id="signaturePreview">
												<% if (isEdit && document.signature) { %>
													<img src="<%= document.signature %>" alt="Signature"
														style="max-height:100%; max-width:100%; object-fit:contain;">
													<% } %>
											</div>
											<div class="signupld">
												<input type="file" class="form-control d-none" id="fileSign"
													name="signature" accept="image/*">
												<button type="button" class="btn btn-primary rounded-pill"
													id="uploadSignBtn">
													<%= isEdit && document.signature ? 'Update Signature'
														: 'Browse from system' %>
												</button>
											</div>
										</div>
									</div>

									<!-- Link -->
									<div class="col-md-12">
										<div class="mb-3">
											<label class="form-label">Add Link (if any)</label>
											<input type="url" class="form-control" name="link"
												placeholder="https://example.com"
												value="<%= isEdit && document.link ? document.link : '' %>">
										</div>
									</div>
								</div>
							</div>

							<div class="d-flex align-items-center justify-content-end">
								<button class="btn btn-primary rounded-pill" type="submit" id="submitBtn">
									<%= isEdit ? "Update Document" : "Add Document" %>
								</button>
							</div>
				</form>
			</div>
		</div>

		<!-- Footer -->
		<div class="footer mt-4 d-sm-flex align-items-center justify-content-between border-top bg-white p-3">
			<p class="mb-0">2025 &copy; HLFPPT.</p>
			<p>Designed & Developed by <a href="javascript:void(0);" class="text-primary">Duplex services &
					Technology</a></p>
		</div>
	</div>
	<!-- /Page Wrapper -->

	<%- include('../partials/footer') %>


		<!-- Metadata Modal -->
		<div id="metadata-modal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">Add Metadata</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<form id="metadataForm">
							<div class="mb-3">
								<label class="form-label">File Name</label>
								<input class="form-control" type="text" name="fileName" required placeholder="File Name"
									value="<%= isEdit && document.metadata && document.metadata.fileName ? document.metadata.fileName : '' %>">
							</div>
							<div class="mb-3">
								<label class="form-label">File description</label>
								<input class="form-control" type="text" name="fileDescription" required
									placeholder="Project about the new KVP app"
									value="<%= isEdit && document.metadata && document.metadata.fileDescription ? document.metadata.fileDescription : '' %>">
							</div>
							<div class="mb-3">
								<label class="form-label">File main Heading</label>
								<input type="text" class="form-control" name="mainHeading" placeholder="Main Heading"
									value="<%= isEdit && document.metadata && document.metadata.mainHeading ? document.metadata.mainHeading : '' %>">
							</div>
							<div class="mb-3 text-center">
								<button class="btn btn-primary rounded-pill" type="submit">Save Metadata</button>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>
		<!-- /Metadata Modal -->

		<!-- Success Modal -->
		<div id="data-success-modal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered modalw620">
				<div class="modal-content">
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					<div class="modal-body">
						<div class="success_mdltxt text-center">
							<div class="imgscs mb-3"><img src="/img/icons/success.png"></div>
							<div class="d-flex align-items-center justify-content-center mb-2">
								<span class="avatar rounded bg-light mb-2">
									<img src="/img/icons/fn1.png">
								</span>
								<div class="ms-2">
									<p class="fs-14 mb-1 fw-normal" id="successFileName">Project Proposal v1</p>
								</div>
							</div>
							<h4 class="fs-24 text-dark fw-medium mb-4">Your File <%= isEdit ? "Updated" : "Added" %>
									Successfully</h4>
							<p class="fs-20 fw-normal mb-4">You will be notified soon as your file gets approved</p>
							<div class="mb-3 text-center">
								<button class="btn btn-primary rounded-pill minw80" type="button"
									data-bs-dismiss="modal">Ok</button>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- /Success Modal -->

		<script>
			// EJS variables converted to JS
			const isEdit = <%= isEdit ? 'true' : 'false' %>;
			const documentId = "<%= isEdit && document ? document._id : '' %>";

			// Store uploaded file IDs
			let uploadedFileIds = [];

			$(document).ready(function () {
				// --------------------------
				// Summernote
				// --------------------------
				$('.summernote').summernote({
					height: 200,
					callbacks: {
						onChange: function (contents) {
							$('#summernote').val(contents);
						}
					}
				});

				// --------------------------
				// Select2
				// --------------------------
				$('.select2').select2();

				// --------------------------
				// Datepicker
				// --------------------------
				$('.datetimepicker').datetimepicker({
					format: 'DD-MM-YYYY',
					useCurrent: false
				});

				// --------------------------
				// Compliance radio buttons
				// --------------------------
				$('input[name="compliance"]').change(function () {
					if ($(this).val() === 'yes') {
						$('#expiryDateContainer').show();
						$('input[name="expiryDate"]').prop('required', true);
					} else {
						$('#expiryDateContainer').hide();
						$('input[name="expiryDate"]').prop('required', false);
					}
				});

				// --------------------------
				// Metadata modal
				// --------------------------
				$('#metadataForm').on('submit', function (e) {
					e.preventDefault();
					const formData = $(this).serializeArray();
					const metadata = {};
					formData.forEach(item => metadata[item.name] = item.value);

					$('#metadataInput').val(JSON.stringify(metadata));
					$('#metadataDisplay').val(metadata.fileName + ' - ' + metadata.fileDescription);
					$('#metadata-modal').modal('hide');
				});

				// --------------------------
				// File upload handling
				// --------------------------
				const uploadBox = document.getElementById("uploadBox");
				const fileInput = document.getElementById("fileInput");
				const fileList = document.getElementById("fileList");

				uploadBox.addEventListener("click", () => fileInput.click());

				fileInput.addEventListener("change", async (e) => {
					const files = e.target.files;
					for (let i = 0; i < files.length; i++) {
						await handleFileUpload(files[i]);
					}
				});

				uploadBox.addEventListener("dragover", e => {
					e.preventDefault();
					uploadBox.classList.add("dragover");
				});

				uploadBox.addEventListener("dragleave", () => {
					uploadBox.classList.remove("dragover");
				});

				uploadBox.addEventListener("drop", async e => {
					e.preventDefault();
					uploadBox.classList.remove("dragover");
					const files = e.dataTransfer.files;
					for (let i = 0; i < files.length; i++) {
						await handleFileUpload(files[i]);
					}
				});

				async function handleFileUpload(file) {
					const fileId = Date.now() + Math.random();
					const fileItem = document.createElement("div");
					fileItem.className = "file-item col-sm-5 mb-3 p-3 border rounded";
					fileItem.setAttribute("data-id", fileId);

					// Choose icon based on file type
					let iconClass = "fa-file";
					if (file.type.includes("word")) iconClass = "fa-file-word text-primary";
					else if (file.type.includes("pdf")) iconClass = "fa-file-pdf text-danger";
					else if (file.type.includes("presentation") || file.name.endsWith(".ppt") || file.name.endsWith(".pptx")) iconClass = "fa-file-powerpoint text-warning";
					else if (file.type.includes("sheet") || file.name.endsWith(".xls") || file.name.endsWith(".xlsx")) iconClass = "fa-file-excel text-success";

					fileItem.innerHTML = `
					<div class="file-info d-flex align-items-center">
						<i class="fa-solid ${iconClass} fa-2x me-3"></i>
						<div class="flex-grow-1">
							<h6 class="mb-0 text-truncate">${file.name}</h6>
							<small class="text-muted">${(file.size / 1024 / 1024).toFixed(2)} MB</small>
						</div>
					</div>
					<div class="file-progress mt-2">
						<div class="progress">
							<div class="progress-bar bg-success" role="progressbar" style="width: 0%">0%</div>
						</div>
					</div>
					<button class="remove-btn btn btn-sm btn-danger mt-2" data-fileid="${fileId}">
						<i class="fa-solid fa-xmark"></i> Remove
					</button>
				`;
					fileList.appendChild(fileItem);

					const progressBar = fileItem.querySelector(".progress-bar");

					try {
						const formData = new FormData();
						formData.append('file', file);

						const response = await fetch('/api/files/upload', { method: 'POST', body: formData });
						const data = await response.json();

						if (data.success) {
							progressBar.style.width = "100%";
							progressBar.textContent = "100%";
							uploadedFileIds.push(data.fileId);
							fileItem.setAttribute("data-file-id", data.fileId);
							fileItem.querySelector(".remove-btn").setAttribute("data-file-id", data.fileId);
						} else throw new Error(data.message || "Upload failed");

					} catch (error) {
						console.error("Upload error:", error);
						progressBar.classList.remove("bg-success");
						progressBar.classList.add("bg-danger");
						progressBar.textContent = "Error";

						const errorMsg = document.createElement("div");
						errorMsg.className = "text-danger small mt-1";
						errorMsg.textContent = "Upload failed. Please try again.";
						fileItem.appendChild(errorMsg);
					}

					fileItem.querySelector(".remove-btn").addEventListener("click", function () {
						const fileIdToRemove = this.getAttribute("data-file-id");
						if (fileIdToRemove) {
							uploadedFileIds = uploadedFileIds.filter(id => id !== fileIdToRemove);
							fetch(`/api/files/${fileIdToRemove}`, { method: 'DELETE' }).catch(err => console.error(err));
						}
						fileItem.remove();
					});
				}

				// Remove existing files in edit mode
				document.querySelectorAll('.remove-btn[data-file-id]').forEach(btn => {
					btn.addEventListener('click', function () {
						const fileId = this.getAttribute('data-file-id');
						const fileItem = this.closest('.file-item');
						fetch(`/api/files/${fileId}`, { method: 'DELETE' })
							.then(res => res.json())
							.then(data => data.success ? fileItem.remove() : alert('Error deleting file: ' + data.message))
							.catch(err => { console.error(err); alert('Error deleting file'); });
					});
				});

				// --------------------------
				// Signature upload
				// --------------------------
				const fileSign = document.getElementById('fileSign');
				const uploadSignBtn = document.getElementById('uploadSignBtn');
				const signaturePreview = document.getElementById('signaturePreview');

				uploadSignBtn.addEventListener('click', () => fileSign.click());

				fileSign.addEventListener('change', function () {
					if (this.files && this.files[0]) {
						const reader = new FileReader();
						reader.onload = function (e) {
							signaturePreview.innerHTML = `<img src="${e.target.result}" alt="Signature Preview" style="max-height:100%; max-width:100%; object-fit:contain;">`;
							uploadSignBtn.textContent = "Update Signature";
						};
						reader.readAsDataURL(this.files[0]);
					}
				});

				// --------------------------
				// Form submission
				// --------------------------
				$('#documentForm').on('submit', async function (e) {
					e.preventDefault();
					$('#summernote').val($('.summernote').summernote('code'));

					$('#submitBtn').prop('disabled', true).html(
						'<span class="spinner-border spinner-border-sm" role="status"></span> ' + (isEdit ? "Updating..." : "Adding...")
					);

					try {
						const fileIdsInput = document.createElement('input');
						fileIdsInput.type = 'hidden';
						fileIdsInput.name = 'fileIds';
						fileIdsInput.value = JSON.stringify(uploadedFileIds);
						this.appendChild(fileIdsInput);

						const formData = new FormData(this);
						const url = isEdit ? '/api/documents/' + documentId : '/api/documents';
						const method = isEdit ? 'PATCH' : 'POST';

						const response = await fetch(url, { method, body: formData });
						const data = await response.json();

						if (data.success) {
							if (data.document?.metadata?.fileName) {
								$('#successFileName').text(data.document.metadata.fileName);
							}
							$('#data-success-modal').modal('show');

							if (!isEdit) {
								$('#data-success-modal').on('hidden.bs.modal', function () {
									window.location.href = '/documents/add';
								});
							}
						} else {
							alert('Error: ' + (data.message || 'Unknown error occurred'));
						}
					} catch (error) {
						console.error('Error:', error);
						alert('An error occurred while submitting the form.');
					} finally {
						$('#submitBtn').prop('disabled', false).html(isEdit ? "Update Document" : "Add Document");
					}
				});
			});
		</script>