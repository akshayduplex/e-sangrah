<%- include('../../partials/header') %>

	<div class="page-wrapper">
		<div class="content">
			<!-- Breadcrumb -->
			<div class="d-flex align-items-center justify-content-between page-breadcrumb mb-3">
				<div class="my-auto mb-2">
					<h2 class="mb-1">Approval Tracking</h2>
					<nav>
						<ol class="breadcrumb mb-0">
							<li class="breadcrumb-item"><a href="#"><i class="ti ti-smart-home"></i></a></li>
							<li class="breadcrumb-item"><a href="#">Dashboard</a></li>
							<li class="breadcrumb-item">Approval Tracking</li>
						</ol>
					</nav>
				</div>
			</div>

			<div class="dflexbtwn align-items-start">
				<div class="docstatus">
					<h5 class="fs-20 mb-3 fw-medium">Document Status</h5>
					<div class="flxtblleft">
						<span class="avatar rounded bg-light mb-2">
							<img id="doc-icon" src="/img/icons/fn1.png" alt="Document Icon">
						</span>
						<div class="flxtbltxt">
							<p class="fs-14 mb-1 fw-normal text-neutral" id="doc-name">-</p>
							<span class="fs-11 fw-light text-black" id="doc-size">-</span><br>
						</div>
					</div>
					<p class="fs-20 fw-medium" id="doc-submitted">Submitted on: -</p>
					<a id="doc-link" class="btn-primary btn rounded-pill" target="_blank">View File</a>
				</div>

				<div class="progresscard">
					<div class="progresschart">
						<div id="chartprogress" style="width:100%; height: 260px;"></div>
					</div>
				</div>
			</div>

			<div class="mt-3 position-relative">
				<div class="approval-tracker">
					<table class="table table-nowrap mb-0">
						<thead>
							<tr>
								<th>Designation</th>
								<th>Name</th>
								<th>Approved On</th>
								<th>Request Status</th>
								<th>Remark</th>
								<th>Action</th>
							</tr>
						</thead>
						<tbody id="approval-table">
							<tr>
								<td colspan="5" class="text-center">Loading approvals...</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>

		<div class="footer mt-4 d-sm-flex align-items-center justify-content-between border-top bg-white p-3">
			<p class="mb-0">2025 &copy; HLFPPT.</p>
			<p>Designed & Developed by <a href="javascript:void(0);" class="text-primary">Duplex services &
					Technology</a></p>
		</div>
	</div>

	<%- include('../../partials/footer') %>

		<script>
			document.addEventListener('DOMContentLoaded', async () => {
				const fileIcons = {
					ppt: "/img/icons/fn1.png",
					pptx: "/img/icons/fn1.png",
					doc: "/img/icons/fn2.png",
					docx: "/img/icons/fn2.png",
					xls: "/img/icons/fn3.png",
					xlsx: "/img/icons/fn3.png",
					pdf: "/img/icons/fn4.png",
					default: "/img/icons/fn1.png"
				};
				const pathParts = window.location.pathname.split('/');
				const documentIndex = pathParts.indexOf('document');
				const documentId = documentIndex !== -1 ? pathParts[documentIndex + 1] : null;
				const id = "<%= user._id %>";
				const profile_type = "<%= user.profile_type %>";

				if (!documentId) {
					showToast("Document ID not found in URL", 'error');
					return;
				}
				try {
					const response = await fetch(`/api/documents/${documentId}/approval/track`);
					if (!response.ok) throw new Error(`HTTP ${response.status}`);
					const data = await response.json();
					const doc = data.data.document;
					const approvals = data.data.approvals || [];
					const isOwner = id === doc.owner._id;
					const isSuperAdmin = profile_type === "superadmin";

					const showAction = isOwner || isSuperAdmin;

					const docNameEl = document.getElementById('doc-name');
					const docSizeEl = document.getElementById('doc-size');
					const docLinkEl = document.getElementById('doc-link');
					const docIconEl = document.getElementById('doc-icon');

					if (doc.files) {
						const file = doc.files;
						docNameEl.innerText = file.originalName || "-";
						docSizeEl.innerText = file.fileSize || "-";

						const versionLabel = doc.currentVersionLabel || file.version || "1.0";
						docLinkEl.href = `/documents/view?documentId=${documentId}&version=${versionLabel}`;
						docLinkEl.target = "_blank";

						const ext = file.originalName.split('.').pop().toLowerCase();
						docIconEl.src = fileIcons[ext] || fileIcons.default;
					} else {
						docNameEl.innerText = "-";
						docSizeEl.innerText = "-";
						docLinkEl.href = "#";
						docIconEl.src = "/img/icons/fn1.png";
					}
					document.getElementById('doc-submitted').innerText = `Submitted on: ${new Date(doc.createdAt).toDateString()}`;

					const tbody = document.getElementById('approval-table');
					if (approvals.length === 0) {
						tbody.innerHTML = `<tr><td colspan="5" class="text-center">No approvals yet</td></tr>`;
					} else {
						approvals.sort((a, b) => {
							const statusPriority = { 'Approved': 1, 'Pending': 2 };
							return (statusPriority[a.status] || 99) - (statusPriority[b.status] || 99);
						});

						tbody.innerHTML = approvals.map((appr, index) => {
							const approver = appr.userId || {};
							const userDetails = approver.userDetails || {};
							const department = userDetails.department?.name || '-';
							const approverDesignation = appr.designation?.name || '-';
							const approverName = approver.name || 'Unknown';

							const status = appr.status || 'Pending';
							const priority = appr.priority ?? '-';
							const isMailSent = appr.isMailSent ?? false;

							let statusBadge = `<span class="status-badge status-${status.toLowerCase()}">${status}</span>`;
							let actionBtn = "";

							if (!showAction) {
								actionBtn = `<span class="text-muted small">No Action</span>`;
							}
							else if (appr.isApproved) {
								actionBtn = `<span class="text-success small fw-bold">Already Approved</span>`;
							}
							else if (!isMailSent && priority !== 1) {
								actionBtn = `<span class="text-muted small">Mail not sent</span>`;
							}
							else {
								actionBtn = `
        <button class="btn btn-sm btn-success send-mail"
            data-project-id="${doc._id}"
            data-approver-id="${approver._id}">
            Send Mail
        </button>`;
							}

							return `
        <tr>
            <td class="d-flex align-items-center">
                <div class="role-icon ${status === 'Approved' ? 'done' : 'pending'}">
                    <i class="ti ${status === 'Approved' ? 'ti-circle-check' : 'ti-hourglass-low'}"></i>
                </div>
                <span class="ms-2">${approverDesignation}</span>
            </td>
            
            <td>${approverName}</td>
            <td>${appr.approvedOn ? new Date(appr.approvedOn).toDateString() : 'In Review'}</td>
            <td>${statusBadge}</td>
            <td>${appr.remark || '-'}</td>

            <!-- ACTION BUTTON COLUMN -->
            <td>${actionBtn}</td>
        </tr>
    `;
						}).join('');

					}

					// Render Approval Progress Chart
					const approvedCount = approvals.filter(a => a.status === "Approved").length;
					const pendingCount = approvals.filter(a => a.status === "Pending").length;

					Highcharts.chart('chartprogress', {
						chart: {
							type: 'pie',
							backgroundColor: 'transparent',
						},
						title: {
							text: 'Approval Progress'
						},
						accessibility: { point: { valueSuffix: '%' } },
						plotOptions: {
							pie: {
								innerSize: '70%',       // doughnut
								borderRadius: 8,        // rounded edges
								dataLabels: {
									enabled: true,
									format: '{point.y}',
									style: {
										fontSize: '14px'
									}
								},
								showInLegend: true
							}
						},
						series: [{
							name: '',
							colorByPoint: true,
							data: [
								{ name: 'Approved', y: approvedCount, color: '#28a745' },
								{ name: 'Pending', y: pendingCount, color: '#ffc107' }
							]
						}],
						credits: { enabled: false },
						exporting: { enabled: false }
					});
				} catch (error) {
					console.error(error);
					showToast("Failed to load approval tracking data", 'error');
				}
				$(document).on('click', '.send-mail', async function () {
					const $btn = $(this);

					if ($btn.prop('disabled')) return;
					$btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span>');

					const projectId = $btn.data('project-id');
					const approverId = $btn.data('approver-id');

					try {
						const res = await fetch(`/api/documents/${projectId}/approval/${approverId}/mail`, {
							method: 'GET',
							credentials: 'include'
						});

						const json = await res.json();

						if (res.ok && json.success) {
							showToast(json.message || 'Mail sent!', 'success');

							$btn.removeClass('btn-success')
								.addClass('btn-outline-success')
								.prop('disabled', true)
								.html('<i class="ti ti-check"></i> Sent');
						} else {
							throw new Error(json.message || 'Failed to send');
						}
					} catch (err) {
						showToast(err.message || 'Network error', 'error');
						$btn.prop('disabled', false).html('Send Mail');
					}
				});
			});
		</script>