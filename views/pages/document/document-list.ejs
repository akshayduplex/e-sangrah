<%- include('../../partials/header') %>

    <!-- Page Wrapper -->
    <div class="page-wrapper">
        <div class="content">
            <!-- Breadcrumb -->
            <div class="d-flex align-items-center justify-content-between page-breadcrumb mb-3">
                <div class="my-auto mb-2">
                    <h2 class="mb-1">All Documents ( <span class="totalDoc">10</span> )</h2>
                    <nav>
                        <ol class="breadcrumb mb-0">
                            <li class="breadcrumb-item">
                                <a href="#"><i class="ti ti-smart-home"></i></a>
                            </li>
                            <li class="breadcrumb-item">Dashboard</li>
                            <li class="breadcrumb-item">Report</li>
                            <li class="breadcrumb-item">All Documents</li>
                        </ol>
                    </nav>
                </div>
                <div class="rtbtn">
                    <!-- Search -->
                    <div class="me-auto d-flex align-items-center" id="header-search">
                        <div class="input-group" style="width: 300px;">
                            <input type="text" id="searchInput" class="form-control"
                                placeholder="Search by doc, tag, metadata..">
                            <span class="input-group-text"><i class="ti ti-search"></i></span>
                        </div>
                    </div>
                    <!-- /Search -->
                </div>
            </div>
            <!-- /Breadcrumb -->
            <div class="filter-container mb-3">
                <!-- Row 1: Tabs aligned left -->
                <% if (user.profile_type !=='donor' && user.profile_type !=='vendor' ) { %>

                    <div class="d-flex flex-wrap gap-2 mb-2">
                        <button type="button" class="btn btn-primary rounded-pill status-tab">All</button>
                        <button type="button" class="btn btn-outline-primary rounded-pill status-tab">Pending</button>
                        <button type="button" class="btn btn-outline-primary rounded-pill status-tab">Rejected</button>
                        <button type="button" class="btn btn-outline-primary rounded-pill status-tab">Approved</button>
                        <button type="button" class="btn btn-outline-primary rounded-pill status-tab">Draft</button>
                        <button type="button" class="btn btn-outline-primary rounded-pill status-tab">
                            Compliance and Retention
                        </button>
                    </div>
                    <% } %>
                        <!-- Row 2: Filters & buttons aligned right -->
                        <div class="d-flex gap-2 justify-content-end align-items-end">
                            <div class="mb-0">
                                <select id="department" class="form-select select2" style="width: 200px;">
                                    <option value="">-- Select Department --</option>
                                </select>
                            </div>
                            <div class="mb-0 position-relative">
                                <!-- Filter Button -->
                                <div class="mb-0 position-relative">
                                    <!-- Filter Button -->
                                    <button class="btn btn-outline-primary" id="columnFilterBtn">
                                        <i class="ti ti-adjustments"></i>
                                    </button>

                                    <!-- Filter Dropdown -->
                                    <div class="filter-dropdown d-none p-3 border rounded bg-white shadow-sm position-absolute end-0 mt-2"
                                        style="z-index: 1050; min-width: 220px;">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="fileName"
                                                id="filterFileName" checked>
                                            <label class="form-check-label" for="filterFileName">File name</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="tags"
                                                id="filterTags">
                                            <label class="form-check-label" for="filterTags">Tags</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="metadata"
                                                id="filterMetadata" checked>
                                            <label class="form-check-label" for="filterMetadata">Meta data</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="ownerName"
                                                id="filterOwnerName">
                                            <label class="form-check-label" for="filterOwnerName">Owner name</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="fileType"
                                                id="filterFileType">
                                            <label class="form-check-label" for="filterFileType">File type</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="folderName"
                                                id="filterFolderName" checked>
                                            <label class="form-check-label" for="filterFolderName">Folder name</label>
                                        </div>
                                        <div class="mt-2 d-flex justify-content-between">
                                            <button class="btn btn-primary btn-sm" id="applyFilter">Apply</button>
                                            <button class="btn btn-sm" id="clearFilter">Clear</button>
                                        </div>
                                    </div>
                                </div>
                                <!-- Filter dropdown here -->
                            </div>
                            <div class="position-relative mb-0">

                                <input type="text" class="form-control pe-6" id="documentDate"
                                    placeholder="Select Date Range" readonly>

                                <!-- Calendar Icon -->
                                <span class="calendar-icon">
                                    <i class="ti ti-calendar text-gray-7"></i>
                                </span>

                                <!-- Clear Button (×) -->
                                <button type="button" id="clearDateRange" class="btn-close clear-btn"
                                    title="Clear date range">
                                </button>

                            </div>

                        </div>
            </div>

            <!-- Documents Table -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive" id="documentsTableWrapper">
                        <table class="table table-hover datatable" id="documents_table">
                            <thead class="thead-light">
                                <tr>
                                    <th></th>
                                    <th>File Name</th>
                                    <th>Versions</th>
                                    <th>Tags</th>
                                    <th>Metadata</th>
                                    <th>Last Modified on</th>
                                    <th>Owner</th>
                                    <th>Department</th>
                                    <th>Project Name</th>
                                    <th>Shared With</th>
                                    <th>Donor</th>
                                    <th>Vendor</th>
                                    <th>Description</th>
                                    <th>Remark</th>
                                    <th>Signature</th>
                                    <th>Status</th>
                                    <th>Approvers</th>
                                </tr>
                            </thead>
                            <tbody id="documents_table_body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- /Documents Table -->
    </div>

    <div class="footer mt-4 d-sm-flex align-items-center justify-content-between border-top bg-white p-3">
        <p class="mb-0">2025 &copy; HLFPPT.</p>
        <p>Designed & Developed by <a href="javascript:void(0);" class="text-primary">Duplex services &
                Technology</a></p>
    </div>
    </div>
    <!-- /Page Wrapper -->
    <%- include('../../modals/addApprovers') %>
        <%- include('../../partials/footer') %>
            <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
            <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
            <script src="/js/components/shareDocument.js"></script>
            <script>

                (function ($) {
                    "use strict";

                    const initialStatus = "<%= status %>";
                    const documentId = "<%= documentId %>";
                    const project = "<%= project %>";
                    const currentUserId = "<%= user._id %>";
                    let currentDocId = null;
                    let customFlatpickr = null;
                    let isModalInitializing = false;
                    const baseUrl = window.location.origin;
                    const tableBody = document.querySelector('#approverTable tbody');
                    const form = document.getElementById('addMemberForm');
                    const modalEl = document.getElementById('addMemberModal');
                    const modal = new bootstrap.Modal(modalEl);
                    const memberSelect = document.getElementById('approverSelect');
                    const fileIcons = {
                        ppt: "/img/icons/fn1.png",
                        pptx: "/img/icons/fn1.png",
                        doc: "/img/icons/fn2.png",
                        docx: "/img/icons/fn2.png",
                        xls: "/img/icons/fn3.png",
                        xlsx: "/img/icons/fn3.png",
                        pdf: "/img/icons/fn4.png",
                        default: "/img/icons/fn1.png"
                    };
                    let selectedDateRange = null;

                    const fp = flatpickr("#documentDate", {
                        mode: "range",
                        dateFormat: "d-m-Y",
                        allowInput: false,           // ← Blocks typing completely
                        clickOpens: true,
                        locale: {
                            rangeSeparator: " to "
                        },

                        // When user selects both dates
                        onChange: function (selectedDates, dateStr, instance) {
                            if (selectedDates.length === 2) {
                                selectedDateRange = {
                                    start: selectedDates[0],
                                    end: selectedDates[1]
                                };
                                document.getElementById("clearDateRange").style.display = "block";
                                table.ajax.reload(); // Refresh table with new date range
                            }
                        },

                        // When user clears or closes without full range
                        onClose: function (selectedDates) {
                            if (selectedDates.length < 2 && selectedDates.length > 0) {
                                setTimeout(() => {
                                    fp.clear();
                                }, 100);
                            }
                            if (selectedDates.length === 0) {
                                selectedDateRange = null;
                                document.getElementById("clearDateRange").style.display = "none";
                                table.ajax.reload();
                            }
                        }
                    });

                    // Clear button functionality
                    document.getElementById("clearDateRange").addEventListener("click", function () {
                        fp.clear();
                        selectedDateRange = null;
                        this.style.display = "none";
                        table.ajax.reload();
                    });
                    // Initialize status tabs based on query parameter
                    function initializeStatusTabs() {

                        // Remove active class from all tabs first
                        $('.status-tab').removeClass('btn-primary').addClass('btn-outline-primary');

                        if (initialStatus === "all" || !initialStatus) {
                            // Set "All" as active
                            $('.status-tab').each(function () {
                                if ($(this).text().trim() === 'All') {
                                    $(this).removeClass('btn-outline-primary').addClass('btn-primary');
                                    return false;
                                }
                            });
                        } else {
                            // Find and activate the matching tab
                            let found = false;
                            $('.status-tab').each(function () {
                                const tabText = $(this).text().trim();
                                const statusText = initialStatus;

                                // Handle special case for "Compliance and Retention"
                                if (statusText === 'Compliance and Retention' && tabText.includes('Compliance')) {
                                    $(this).removeClass('btn-outline-primary').addClass('btn-primary');
                                    found = true;
                                    return false;
                                }
                                // Exact match for other statuses
                                else if (tabText === statusText) {
                                    $(this).removeClass('btn-outline-primary').addClass('btn-primary');
                                    found = true;
                                    return false;
                                }
                            });

                            // If no exact match found, default to "All"
                            if (!found) {
                                $('.status-tab').each(function () {
                                    if ($(this).text().trim() === 'All') {
                                        $(this).removeClass('btn-outline-primary').addClass('btn-primary');
                                        return false;
                                    }
                                });
                            }
                        }
                    }
                    // Get current active status for API calls
                    let currentStatus = initialStatus || 'all';

                    function getCurrentStatus() {
                        const statusForApi = currentStatus === 'All' || currentStatus === 'all' ? '' : currentStatus;
                        return statusForApi;
                    }


                    // Initialize
                    $(document).ready(function () {
                        initializeStatusTabs();
                    });

                    document.getElementById("columnFilterBtn").addEventListener("click", function () {
                        const dropdown = document.querySelector(".filter-dropdown");
                        dropdown.classList.toggle("d-none");
                    });

                    document.addEventListener("click", function (event) {
                        const dropdown = document.querySelector(".filter-dropdown");
                        const button = document.getElementById("columnFilterBtn");

                        if (!dropdown.contains(event.target) && !button.contains(event.target)) {
                            dropdown.classList.add("d-none");
                        }
                    });

                    // -------------------------
                    // Initialize Select2 with Clear Option
                    // -------------------------
                    function initSelect2(selector, url, placeholder, textKey) {
                        $(selector).select2({
                            placeholder: placeholder,
                            allowClear: true,
                            ajax: {
                                url,
                                dataType: 'json',
                                delay: 250,
                                data: params => ({ search: params.term }),
                                processResults: data => {
                                    const results = data.data.map(item => ({
                                        id: item._id,
                                        text: item[textKey]
                                    }));
                                    return { results };
                                }
                            }
                        });

                        // Reset selection when clearing
                        $(selector).on('select2:select', function (e) {
                            if (!e.params.data.id) {
                                $(this).val(null).trigger('change');
                            }
                        });
                    }

                    // Initialize Select2
                    initSelect2('#department', `${baseUrl}/api/departments/search`, 'Select Department', 'name');

                    // -------------------------
                    // Initialize DataTable
                    // -------------------------
                    const table = $('#documents_table').DataTable({
                        serverSide: true,
                        processing: true,
                        ajax: {
                            url: `${baseUrl}/api/documents?documentId=${documentId}&project=${project}`,
                            type: 'GET',
                            data: function (d) {
                                const filterColumns = [];

                                $('.filter-dropdown .form-check-input:checked').each(function () {
                                    filterColumns.push($(this).val());
                                });

                                const searchValue = $('#searchInput').val()?.trim() || '';
                                // Properly format date range for backend
                                let dateRangeParam = null;
                                if (selectedDateRange) {
                                    const formatDate = (date) => {
                                        const d = date.getDate().toString().padStart(2, '0');
                                        const m = (date.getMonth() + 1).toString().padStart(2, '0');
                                        const y = date.getFullYear();
                                        return `${d}-${m}-${y}`;
                                    };
                                    dateRangeParam = `${formatDate(selectedDateRange.start)} to ${formatDate(selectedDateRange.end)}`;
                                }
                                const orderColumn = d.order[0]?.column;
                                const orderDir = d.order[0]?.dir || 'desc';

                                return {
                                    page: (d.start / d.length) + 1,
                                    limit: d.length,
                                    status: getCurrentStatus(),
                                    department: $('#department').val(),
                                    dateRange: dateRangeParam,
                                    // date: selectedDate,
                                    search: searchValue,
                                    orderColumn,
                                    filterColumns,
                                    orderDir
                                };
                            },
                            dataSrc: function (json) {
                                $('.totalDoc').text(json.data.pagination.totalDocuments || 0);
                                json.recordsTotal = json.data.pagination.totalDocuments || 0;
                                json.recordsFiltered = json.data.pagination.totalDocuments || 0;
                                return (json.data.documents || []).map(doc => renderRow(doc));
                            }
                        },
                        columns: [
                            { title: '', orderable: false },
                            { title: 'File Name', orderable: true },
                            { title: 'Version', orderable: false },
                            { title: 'Metadata', orderable: true },
                            { title: 'Tags', orderable: true },
                            { title: 'Last Modified on', orderable: true },
                            { title: 'Owner', orderable: true },
                            { title: 'Department', orderable: true },
                            { title: 'Project Name', orderable: true },
                            { title: 'Shared With', orderable: false },
                            { title: 'Donor', orderable: true },
                            { title: 'Vendor', orderable: true },
                            { title: 'Description', orderable: false },
                            { title: 'Remark', orderable: false },
                            { title: 'Signature', orderable: false },
                            { title: 'Status', orderable: true },
                            { title: 'Approvers', orderable: false }
                        ],
                        searching: false,
                        lengthChange: true,
                        pageLength: 10,
                        lengthMenu: [10, 25, 50, 100],
                        order: [[2, 'desc']],
                        deferRender: true,
                        stateSave: true,
                        dom: "<'row'<'col-sm-12 col-md-6'l><'col-sm-12 col-md-6'f>>" +
                            "<'row'<'col-sm-12'tr>>" +
                            "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",
                        drawCallback: function () {
                            $('#documents_table_wrapper .dataTables_paginate').addClass('float-end mt-2');
                            $('#documents_table_wrapper .dataTables_info').addClass('text-start mt-2');
                        }
                    });

                    $('#documents_table').on('draw.dt', function () {
                        const tooltipTriggerList = [].slice.call(document.querySelectorAll('#documents_table [title]'));
                        tooltipTriggerList.map(function (tooltipTriggerEl) {
                            return new bootstrap.Tooltip(tooltipTriggerEl);
                        });
                    });

                    // -------------------------
                    // Status Tab Handling with URL Update
                    // -------------------------
                    $('.status-tab').on('click', function () {
                        $('.status-tab').removeClass('btn-primary').addClass('btn-outline-primary');
                        $(this).removeClass('btn-outline-primary').addClass('btn-primary');

                        const selectedStatus = $(this).text().trim();
                        const statusParam = selectedStatus === 'All' ? 'all' : selectedStatus;

                        currentStatus = selectedStatus;

                        updateUrlParameter('status', statusParam);
                        table.ajax.reload();
                    });


                    function updateUrlParameter(key, value) {
                        const url = new URL(window.location);
                        if (value === 'all' || value === '') {
                            url.searchParams.delete(key);
                        } else {
                            url.searchParams.set(key, value);
                        }
                        window.history.pushState({}, '', url);
                    }
                    window.addEventListener('popstate', function () {
                        const urlParams = new URLSearchParams(window.location.search);
                        const statusFromUrl = urlParams.get('status') || 'all';

                        currentStatus = statusFromUrl;
                        initializeStatusTabs();
                        table.ajax.reload();
                    });


                    // -------------------------
                    // Other Event Handlers
                    // -------------------------
                    $("#applyFilter").on("click", function () {
                        $(".filter-dropdown").addClass("d-none");
                        table.ajax.reload();
                    });

                    $("#clearFilter").on("click", function () {
                        $('.filter-dropdown .form-check-input').prop("checked", false);
                        $(".filter-dropdown").addClass("d-none");
                        table.ajax.reload();
                    });

                    $('#department').on('change', function () {
                        table.ajax.reload();
                    });

                    $('#searchInput').on('input', debounce(() => {
                        table.ajax.reload();
                    }, 500));

                    $('#searchInput').on('keypress', function (e) {
                        if (e.which === 13) {
                            table.ajax.reload();
                        }
                    });

                    function debounce(fn, delay = 500) {
                        let timer;
                        return function (...args) {
                            clearTimeout(timer);
                            timer = setTimeout(() => fn.apply(this, args), delay);
                        };
                    }

                    // -------------------------
                    // Render each row
                    // -------------------------
                    function renderRow(doc) {
                        const currentUserId = "<%= user._id %>";
                        const currentUserProfileType = "<%= user.profile_type %>";

                        // New Logic: Full access if Owner OR Superadmin
                        const isOwner = doc.owner && doc.owner._id === currentUserId;
                        const isSuperAdmin = currentUserProfileType === 'superadmin';
                        const hasFullAccess = isOwner || isSuperAdmin;

                        var fileSizeKB = doc.files?.fileSize || 'N/A';
                        const lastModified = formatDateTime(doc.updatedAt);

                        const owner = doc.owner
                            ? (() => {
                                const imgSrc = doc.owner.profile_image || '/img/users/user-08.jpg';
                                return `
        <div class="avatar-group">
          <img src="${imgSrc}" class="avatar" data-name="${doc.owner.name}" title="${doc.owner.name}" />
        </div>
      `;
                            })()
                            : '-';
                        const departmentName = doc.department?.name || '-';
                        const projectName = doc.project?.projectName || '-';
                        const tags = doc.tags?.length ? doc.tags.join(', ') : '-';
                        const description = doc.description
                            ? (() => {
                                const text = doc.description.replace(/<\/?[^>]+(>|$)/g, '');
                                return text.length > 100 ? text.substring(0, 30) + '....' : text;
                            })()
                            : '-';

                        const metadata = doc.metadata ? `${doc.metadata.fileName || '-'}, ${doc.metadata.fileDescription || '-'}` : '-';
                        const sharedWith = doc.sharedWithUsers?.length
                            ? (() => {
                                const users = doc.sharedWithUsers.slice(0, 3);
                                const remaining = doc.sharedWithUsers.length - users.length;

                                const avatars = users.map(u => {
                                    const imgSrc = u.profile_image || '/img/users/user-01.jpg';
                                    return `<img src="${imgSrc}" class="avatar" data-name="${u.name}" title="${u.name}" />`;
                                }).join('');

                                const more = remaining > 0
                                    ? `<div class="avatar avatar-more">+${remaining}</div>`
                                    : '';

                                return `<div class="avatar-group">${avatars}${more}</div>`;
                            })()
                            : '-';
                        const donor = doc.documentDonor?.name || '-';
                        const vendor = doc.documentVendor?.name || '-';
                        const statusClass = {
                            'draft': 'bg-soft-info',
                            'pending': 'bg-soft-warning',
                            'approved': 'bg-soft-success',
                            'rejected': 'bg-soft-danger',
                            'underreview': 'bg-soft-warning',
                            'archived': 'bg-soft-secondary'
                        }[(doc.status || '').toLowerCase().replace(/\s+/g, '')] || 'bg-soft-secondary';

                        const currentVersionLabel = doc.currentVersionLabel
                            ? parseFloat(doc.currentVersionLabel)
                            : null;

                        const currentVersion = currentVersionLabel !== null
                            ? `v${currentVersionLabel.toFixed(1)}`
                            : '-';

                        let allVersions = [];

                        if (currentVersionLabel !== null) {

                            let v = 1.0;
                            while (v <= currentVersionLabel + 0.00001) {
                                allVersions.push(`v${v.toFixed(1)}`);
                                v += 0.1;
                                v = Math.round(v * 10) / 10;
                            }
                        }
                        const versionDisplay = `
                                             <div>
                                                <div><strong>Current Version:</strong> ${currentVersion}</div>
                                                <div><strong>Versions:</strong> ${allVersions.join(', ')}</div>
                                             </div>`;
                        const filesInfo = doc?.files
                            ? `<div class="d-flex align-items-center">
                    <span class="avatar rounded bg-light me-2">
                        <img src="${fileIcons[doc?.files?.originalName.split('.').pop().toLowerCase()] || fileIcons.default}" style="height:30px;">
                    </span>
                    <div>
                         <p class="mb-0 text-dark">${doc?.metadata?.fileName || 'N/A'}</p>
                        <small class="text-muted">${doc?.files.fileSize}</small>
                    </div>
                </div>`
                            : '-';
                        let dropdown;
                        if (hasFullAccess) {
                            dropdown = `
            <div class="btn-group" role="group">
                <button type="button" class="btn border-0" data-bs-toggle="dropdown"><i class="ti ti-settings"></i></button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="/documents/${doc._id}/versions/view?version=""><i class="ti ti-eye"></i> View</a></li>
                    <li><a class="dropdown-item" href="/documents/edit/${doc._id}"><i class="ti ti-pencil-minus"></i> Edit</a></li>
                    <li>
                        <a class="dropdown-item share-btn" href="#" data-doc-id="${doc._id}"  data-file-id="${doc.files?._id || ''}"  data-bs-toggle="modal" data-bs-target="#sharedoc-modal">
                            <i class="ti ti-share"></i> Share
                        </a>
                    </li>
                    <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-id="${doc._id}" data-bs-target="#versionhistory-modal"><i class="ti ti-history"></i> Version History</a></li>
                    <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-file-id="${doc.files?._id || ''}" data-bs-target="#downloaddoc-modal"><i class="ti ti-download"></i> Download</a></li>
                    <li><a class="dropdown-item btn-delete" href="#" data-id="${doc._id}" data-bs-toggle="modal" data-bs-target="#trashdoc-modal"><i class="ti ti-trash"></i> Move to Trash</a></li>
                    <li><a class="dropdown-item archive-document" href="#"  data-id="${doc._id}" data-bs-toggle="modal" data-bs-target="#archivedoc-modal"><i class="ti ti-archive"></i> Move to Archive</a></li>
                </ul>
            </div>
        `;
                        } else {
                            dropdown = `
            <div class="btn-group" role="group">
                <button type="button" class="btn border-0" data-bs-toggle="dropdown">
                    <i class="ti ti-settings"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><a class="dropdown-item" href="/documents/${doc._id}/versions/view?version=""><i class="ti ti-eye"></i> View</a></li>
                </ul>
            </div>
        `;
                        }

                        return [
                            dropdown,
                            filesInfo,
                            versionDisplay,
                            metadata,
                            tags,
                            lastModified,
                            owner,
                            departmentName,
                            projectName,
                            sharedWith,
                            donor,
                            vendor,
                            description,
                            doc.comment || '-',
                            doc.signature?.fileUrl ? `<img src="${doc.signature.fileUrl}" style="height:40px;">` : '-',
                            `<span class="badge ${statusClass}">${doc.status}</span>`,
                            doc.wantApprovers
                                ? `<button class="btn btn-sm btn-primary add-approver-btn" data-bs-toggle="modal" data-bs-target="#addMemberModal" data-id="${doc._id}">View</button>`
                                : `<button class="btn btn-sm btn-secondary" disabled>No Action</button>`
                        ];
                    }
                    $("#applyFilter").on("click", function () {
                        $(".filter-dropdown").addClass("d-none");
                        table.ajax.reload();
                    });

                    $("#clearFilter").on("click", function () {
                        $('.filter-dropdown .form-check-input').prop("checked", false);
                        $(".filter-dropdown").addClass("d-none");
                        table.ajax.reload();
                    });

                    // -------------------------
                    // Filters & Tabs
                    // ------------------------

                    $('#department').on('change', function () {
                        table.ajax.reload();
                    });

                    $('#searchInput').on('input', debounce(() => {
                        table.ajax.reload();
                    }, 500));

                    $('#searchInput').on('keypress', function (e) {
                        if (e.which === 13) {
                            table.ajax.reload();
                        }
                    });

                    function debounce(fn, delay = 500) {
                        let timer;
                        return function (...args) {
                            clearTimeout(timer);
                            timer = setTimeout(() => fn.apply(this, args), delay);
                        };
                    }

                    // -------------------------
                    // Delete document
                    // -------------------------
                    $(document).on('click', '.btn-delete', function (e) {
                        e.preventDefault();
                        const docId = $(this).data('id');
                        $('#trashdoc-modal').modal('show');

                        $('#confirm-trash-folder').off('click').on('click', function () {
                            $.ajax({
                                url: `${baseUrl}/api/documents/${docId}`,
                                type: 'DELETE',
                                success: function (response) {
                                    $('#trashdoc-modal').modal('hide');
                                    table.ajax.reload();
                                    // show server message if available
                                    showToast(response.message || 'Document moved to trash!', 'success');
                                },
                                error: function (xhr) {
                                    let msg = 'Error moving document to trash.';
                                    if (xhr.responseJSON && xhr.responseJSON.message) {
                                        msg = xhr.responseJSON.message; // display actual server message
                                    }
                                    showToast(msg, 'error');
                                }
                            });
                        });
                    });

                    // -------------------------
                    // Archive Document
                    // -------------------------
                    $(document).on('click', '.archive-document', function (e) {
                        e.preventDefault();

                        const docId = $(this).data('id');
                        const docName = $(this).closest('tr').find('td:nth-child(2) p').text().trim() || 'this document';
                        const isArchived = true;

                        // Update modal text before showing
                        $('#archivedoc-modal .modal-body').text(`Are you sure you want to archive ${docName}?`);
                        $('#archivedoc-modal .modal-title').html(`<img src="/img/icons/archvbin.png"> <br>Move to Archive`);

                        // Show modal
                        $('#archivedoc-modal').modal('show');

                        // Confirm action on "Yes, Move"
                        $('#archivedoc-modal .btn-primary').off('click').on('click', function () {
                            $.ajax({
                                url: `${baseUrl}/api/documents/${docId}/archive?isArchived=${isArchived}`,
                                type: 'PATCH',
                                success: function (response) {
                                    $('#archivedoc-modal').modal('hide');
                                    table.ajax.reload(null, false);
                                    showToast(response.message || 'Document moved to archive successfully!', 'success');
                                },
                                error: function (xhr) {
                                    let msg = 'Error moving document to archive.';
                                    if (xhr.responseJSON && xhr.responseJSON.message) {
                                        msg = xhr.responseJSON.message;
                                    }
                                    showToast(msg, 'error');
                                }
                            });
                        });
                    });

                    // Function to load users for invite dropdown
                    function loadUsersForInvite() {
                        $.ajax({
                            url: `${baseUrl}/api/user`,
                            method: 'GET',
                            success: function (response) {
                                const select = $('#userInviteSelect');
                                select.empty();

                                if (response.data && response.data.length) {
                                    response.data.forEach(user => {
                                        select.append(`<option value="${user.email}">${user.name} (${user.email})</option>`);
                                    });
                                }
                            },
                            error: function (err) {
                                console.error('Failed to load users:', err);
                            }
                        });
                    }
                    /* ----------------------------------------
                       Initialize Approver Modal for View Only
                    ---------------------------------------- */
                    $(document).on('click', '.add-approver-btn', async function () {
                        const documentId = $(this).data('id');
                        await loadApprovers(documentId);
                    });

                    /* ---------------------------------------- 
                       Load Approvers (GET only)
                    ---------------------------------------- */
                    async function loadApprovers(documentId) {
                        const tableBody = document.querySelector('#approverTable tbody');
                        tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">Loading...</td></tr>`;

                        try {
                            const res = await fetch(`/api/documents/${documentId}/approval/track`);
                            const data = await res.json();

                            if (!data.success) {
                                tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">${data.message || 'No approvers found'}</td></tr>`;
                                return;
                            }

                            const approvals = data.data?.approvals || [];
                            const documentData = data.data?.document || {};
                            const projectId = documentData._id || '';

                            tableBody.innerHTML = '';

                            if (approvals.length === 0) {
                                tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">No approvers found.</td></tr>`;
                                return;
                            }

                            const highestPriority = Math.min(...approvals.map(a => a.priority ?? Infinity));

                            approvals.forEach((approval, index) => {
                                const approver = approval.userId || {};
                                const userDetails = approver.userDetails || {};
                                const department = userDetails.department?.name || '-';
                                const approverDesignation = approval.designation?.name || '-';

                                const approverName = approver.name || 'Unknown';
                                const roleInfo = `${approverDesignation} – ${department}`;

                                const priority = approval.priority ?? '-';
                                const status = approval.status || 'Pending';
                                const isMailSent = approval.isMailSent ?? false;

                                // ---- STATUS BADGE ----
                                let statusBadge = `<span class="badge bg-secondary">${status}</span>`;
                                if (status === 'Pending') statusBadge = `<span class="badge bg-warning text-dark">Pending</span>`;
                                if (status === 'Approved') statusBadge = `<span class="badge bg-success">Approved</span>`;
                                if (status === 'Rejected') statusBadge = `<span class="badge bg-danger">Rejected</span>`;

                                // ---- ACTION BUTTONS ----
                                let actionCellContent = '';
                                if (approval.isApproved) {
                                    actionCellContent = `<span class="text-success small">Already Approved</span>`;
                                } else if (!isMailSent && priority !== highestPriority) {
                                    actionCellContent = `<span class="text-muted small">Mail not send</span>`;
                                } else {
                                    actionCellContent = `<button class="btn btn-sm btn-success send-mail"
                    data-project-id="${projectId}"
                    data-approver-id="${approver._id}">Send Mail</button>`;
                                }
                                // ---- Render Row ----
                                const row = document.createElement('tr');
                                row.innerHTML = `
                <td>${index + 1}</td>
                <td>${approverName}<br><small class="text-muted">${roleInfo}</small></td>
                <td>${priority}</td>
                <td>${statusBadge}</td>
                <td>${approval.remark || '-'}</td>
                <td>${actionCellContent}</td>
            `;
                                tableBody.appendChild(row);
                            });

                        } catch (err) {
                            console.error('Error loading approvals:', err);
                            tableBody.innerHTML = `<tr><td colspan="6" class="text-danger text-center">Error loading approvals.</td></tr>`;
                        }
                    }


                    /* -----------------------------------------------------------------
            2. SEND APPROVAL-MAIL – read IDs from button data-attributes
         ----------------------------------------------------------------- */
                    $(document).on('click', '.send-mail', async function () {
                        const $btn = $(this);
                        const $row = $btn.closest('tr');

                        // ---- Prevent double-click ----
                        if ($btn.prop('disabled')) return;
                        $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span>');

                        const projectId = $btn.data('project-id');
                        const approverId = $btn.data('approver-id');
                        try {
                            const res = await fetch(`${baseUrl}/api/documents/${projectId}/approval/${approverId}/mail`, {
                                method: 'GET',
                                credentials: 'include'
                            });

                            const json = await res.json();

                            if (res.ok && json.success) {
                                showToast(json.message || 'Approval mail sent!', 'success');

                                // Mark button as sent
                                $btn.removeClass('btn-success')
                                    .addClass('btn-outline-success')
                                    .prop('disabled', true)
                                    .html('<i class="ti ti-check"></i> Sent');
                            } else {
                                throw new Error(json.message || 'Failed to send');
                            }
                        } catch (err) {
                            console.error(err);
                            showToast(err.message || 'Network error', 'error');
                            $btn.prop('disabled', false).html('Send Mail');
                        }
                    });
                })(jQuery);
            </script>