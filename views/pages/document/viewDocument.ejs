<%- include('../../partials/header') %>

    <div class="page-wrapper">
        <div class="content container-fluid">
            <!-- Breadcrumb -->
            <div class="d-md-flex d-block align-items-center justify-content-between page-breadcrumb mb-4">
                <div class="mb-2 mb-md-0">
                    <h2 class="mb-1 fw-bold text-primary">Document Version Details</h2>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-0">
                            <li class="breadcrumb-item"><a href="/documents">Documents</a></li>
                            <li class="breadcrumb-item active" aria-current="page">Version Details</li>
                        </ol>
                    </nav>
                </div>
            </div>

            <!-- Expired Message -->
            <% if (typeof expiredMessage !=='undefined' && expiredMessage) { %>
                <div class="alert alert-warning alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <%= expiredMessage %>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                <% } %>

                    <!-- Main Card -->
                    <div class="card shadow-lg border-0 rounded-3 overflow-hidden">
                        <div class="card-header bg-light text-white py-3">
                            <h5 class="mb-0 fw-bold">
                                <i class="bi bi-file-earmark-text me-2"></i>
                                <span id="fileNameDisplay">-</span>
                                <span id="currentVersionDisplay" class="text-success fw-semibold ms-2"
                                    style="display:none;">
                                    v1.2 (Current Version)
                                </span>
                            </h5>
                        </div>
                        <div class="card-body p-4">

                            <!-- Accordion for Sections -->
                            <div class="accordion accordion-flush" id="documentAccordion">

                                <!-- Document Information -->
                                <div class="accordion-item border rounded mb-3 shadow-sm">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed fw-semibold" type="button"
                                            data-bs-toggle="collapse" data-bs-target="#collapseInfo">
                                            <i class="bi bi-info-circle me-2 text-primary"></i> Document Information
                                        </button>
                                    </h2>
                                    <div id="collapseInfo" class="accordion-collapse collapse show"
                                        data-bs-parent="#documentAccordion">
                                        <div class="accordion-body">
                                            <div class="row g-3">
                                                <div class="col-md-6">
                                                    <label class="form-label fw-semibold text-muted">Document
                                                        Name</label>
                                                    <input type="text" id="fileName"
                                                        class="form-control form-control-sm" readonly>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label fw-semibold text-muted">Status</label>
                                                    <input type="text" id="status" class="form-control form-control-sm"
                                                        readonly>
                                                </div>
                                                <div class="col-12">
                                                    <label class="form-label fw-semibold text-muted">Description</label>
                                                    <div id="description" class="form-control bg-light p-3"
                                                        style="min-height: 60px; height: auto;" readonly></div>
                                                </div>
                                                <div class="col-12">
                                                    <label class="form-label fw-semibold text-muted">Tags</label>
                                                    <div id="tagsContainer" class="d-flex gap-2 flex-wrap mt-2"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Version Details -->
                                <div class="accordion-item border rounded mb-3 shadow-sm">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed fw-semibold" type="button"
                                            data-bs-toggle="collapse" data-bs-target="#collapseVersion">
                                            <i class="bi bi-git me-2 text-success"></i> Version Details
                                        </button>
                                    </h2>
                                    <div id="collapseVersion" class="accordion-collapse collapse"
                                        data-bs-parent="#documentAccordion">
                                        <div class="accordion-body">
                                            <div class="row g-3">
                                                <div class="col-md-4">
                                                    <label class="form-label fw-semibold text-muted">Version</label>
                                                    <input type="text" id="versionNum"
                                                        class="form-control form-control-sm" readonly>
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label fw-semibold text-muted">Version
                                                        Date</label>
                                                    <input type="text" id="versionDate"
                                                        class="form-control form-control-sm" readonly>
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label fw-semibold text-muted">Changed By</label>
                                                    <input type="text" id="changedBy"
                                                        class="form-control form-control-sm" readonly>
                                                </div>
                                                <div class="col-12">
                                                    <label class="form-label fw-semibold text-muted">Change
                                                        Comments</label>
                                                    <textarea id="changeComment" class="form-control form-control-sm"
                                                        rows="2" readonly></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Project & Department -->
                                <div class="accordion-item border rounded mb-3 shadow-sm">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed fw-semibold" type="button"
                                            data-bs-toggle="collapse" data-bs-target="#collapseProject">
                                            <i class="bi bi-folder-fill me-2 text-warning"></i> Project & Department
                                        </button>
                                    </h2>
                                    <div id="collapseProject" class="accordion-collapse collapse"
                                        data-bs-parent="#documentAccordion">
                                        <div class="accordion-body">
                                            <div class="row g-3">
                                                <div class="col-md-6">
                                                    <label class="form-label fw-semibold text-muted">Project
                                                        Name</label>
                                                    <input type="text" id="projectName"
                                                        class="form-control form-control-sm" readonly>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label fw-semibold text-muted">Department</label>
                                                    <input type="text" id="department"
                                                        class="form-control form-control-sm" readonly>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label fw-semibold text-muted">Folder</label>
                                                    <input type="text" id="folder" class="form-control form-control-sm"
                                                        readonly>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label fw-semibold text-muted">Project
                                                        Manager</label>
                                                    <input type="text" id="projectManager"
                                                        class="form-control form-control-sm" readonly>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Stakeholders -->
                                <div class="accordion-item border rounded mb-3 shadow-sm">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed fw-semibold" type="button"
                                            data-bs-toggle="collapse" data-bs-target="#collapseStakeholders">
                                            <i class="bi bi-people-fill me-2 text-info"></i> Stakeholders
                                        </button>
                                    </h2>
                                    <div id="collapseStakeholders" class="accordion-collapse collapse"
                                        data-bs-parent="#documentAccordion">
                                        <div class="accordion-body">
                                            <div class="row g-3">
                                                <div class="col-md-4">
                                                    <label class="form-label fw-semibold text-muted">Owner</label>
                                                    <input type="text" id="owner" class="form-control form-control-sm"
                                                        readonly>
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label fw-semibold text-muted">Donor</label>
                                                    <input type="text" id="donor" class="form-control form-control-sm"
                                                        readonly>
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label fw-semibold text-muted">Vendor</label>
                                                    <input type="text" id="vendor" class="form-control form-control-sm"
                                                        readonly>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Compliance -->
                                <div class="accordion-item border rounded mb-3 shadow-sm">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed fw-semibold" type="button"
                                            data-bs-toggle="collapse" data-bs-target="#collapseCompliance">
                                            <i class="bi bi-shield-check me-2 text-danger"></i> Compliance Information
                                        </button>
                                    </h2>
                                    <div id="collapseCompliance" class="accordion-collapse collapse"
                                        data-bs-parent="#documentAccordion">
                                        <div class="accordion-body">
                                            <div class="row g-3">
                                                <div class="col-md-6">
                                                    <label class="form-label fw-semibold text-muted">Compliance
                                                        Required</label>
                                                    <input type="text" id="compliance"
                                                        class="form-control form-control-sm" readonly>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label fw-semibold text-muted">Expiry Date</label>
                                                    <input type="text" id="expiryDate"
                                                        class="form-control form-control-sm" readonly>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Dates -->
                                <div class="accordion-item border rounded mb-3 shadow-sm">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed fw-semibold" type="button"
                                            data-bs-toggle="collapse" data-bs-target="#collapseDates">
                                            <i class="bi bi-calendar-event me-2 text-secondary"></i> Dates
                                        </button>
                                    </h2>
                                    <div id="collapseDates" class="accordion-collapse collapse"
                                        data-bs-parent="#documentAccordion">
                                        <div class="accordion-body">
                                            <div class="row g-3">
                                                <div class="col-md-4">
                                                    <label class="form-label fw-semibold text-muted">Created At</label>
                                                    <input type="text" id="createdAt"
                                                        class="form-control form-control-sm" readonly>
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label fw-semibold text-muted">Updated At</label>
                                                    <input type="text" id="updatedAt"
                                                        class="form-control form-control-sm" readonly>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Files -->
                                <div class="accordion-item border rounded mb-3 shadow-sm">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed fw-semibold" type="button"
                                            data-bs-toggle="collapse" data-bs-target="#collapseFiles">
                                            <i class="bi bi-paperclip me-2 text-success"></i> Attached Files
                                        </button>
                                    </h2>
                                    <div id="collapseFiles" class="accordion-collapse collapse"
                                        data-bs-parent="#documentAccordion">
                                        <div class="accordion-body">
                                            <ul id="fileList" class="list-group list-group-flush"></ul>
                                            <div class="text-center text-muted py-3" id="noFiles" style="display:none;">
                                                <i class="bi bi-file-earmark-x fs-1"></i><br>
                                                No files attached
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- External Link -->
                                <div class="accordion-item border rounded mb-3 shadow-sm">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed fw-semibold" type="button"
                                            data-bs-toggle="collapse" data-bs-target="#collapseLink">
                                            <i class="bi bi-link-45deg me-2 text-primary"></i> External Link
                                        </button>
                                    </h2>
                                    <div id="collapseLink" class="accordion-collapse collapse"
                                        data-bs-parent="#documentAccordion">
                                        <div class="accordion-body">
                                            <a id="externalLink" href="#" target="_blank"
                                                class="btn btn-outline-primary w-100 text-start">
                                                <i class="bi bi-box-arrow-up-right me-2"></i>
                                                <span id="linkText">No external link</span>
                                            </a>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
        </div>
    </div>

    <%- include('../../partials/footer') %>

        <!-- Bootstrap Icons (if not included globally) -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

        <style>
            .bg-gradient-primary {
                background: linear-gradient(135deg, #0d6efd, #0b5ed7) !important;
            }

            .accordion-button:not(.collapsed) {
                background-color: #f8f9fa;
                color: #0d6efd;
            }

            .accordion-button:focus {
                box-shadow: none;
                border-color: rgba(0, 0, 0, .125);
            }

            .form-control[readonly] {
                background-color: #f8f9fa;
                opacity: 0.8;
            }

            .badge {
                font-size: 0.8em;
            }

            .list-group-item a {
                text-decoration: none;
                color: #0d6efd;
            }

            .list-group-item a:hover {
                text-decoration: underline;
            }
        </style>

        <script>
            document.addEventListener('DOMContentLoaded', async () => {
                const documentId = "<%= documentId %>";
                const version = new URLSearchParams(window.location.search).get('version');

                try {
                    const res = await fetch(`/api/documents/${documentId}/versions/view?version=${version}`);
                    const data = await res.json();
                    const doc = data.document;

                    // Helper: Format Date
                    const formatDate = (date) => date ? new Date(date).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : '-';

                    // Update Header
                    document.getElementById('fileNameDisplay').textContent = doc.metadata?.fileName || 'Unknown Document';
                    // Show green "Current" only if viewing the latest version
                    const currentVersionDisplay = document.getElementById('currentVersionDisplay');
                    if (version == doc.currentVersionNumber || version == doc.currentVersionLabel) {
                        currentVersionDisplay.style.display = 'inline';
                    } else {
                        currentVersionDisplay.style.display = 'none';
                    }
                    // Document Info
                    document.getElementById('fileName').value = doc.metadata?.fileName || '-';
                    document.getElementById('description').innerHTML = (doc.description || doc.metadata?.fileDescription || 'N/A').replace(/\n/g, '<br>');
                    document.getElementById('status').value = doc.status || 'N/A';

                    // Tags
                    const tagsContainer = document.getElementById('tagsContainer');
                    tagsContainer.innerHTML = '';
                    (doc.tags || []).forEach(tag => {
                        const span = document.createElement('span');
                        span.className = 'badge bg-primary';
                        span.textContent = tag;
                        tagsContainer.appendChild(span);
                    });

                    // Version Details
                    document.getElementById('versionNum').value = version;
                    document.getElementById('versionDate').value = formatDate(data.timestamp);
                    document.getElementById('changedBy').value = data.changedBy?.name || '-';
                    document.getElementById('changeComment').value = data.changes || '-';

                    // Project & Dept
                    document.getElementById('projectName').value = doc.project?.projectName || '-';
                    document.getElementById('department').value = doc.department?.name || '-';
                    document.getElementById('folder').value = doc.folderId?.name || '-';
                    document.getElementById('projectManager').value = doc.projectManager?.name || '-';

                    // Stakeholders
                    document.getElementById('owner').value = doc.owner?.name || '-';
                    document.getElementById('donor').value = doc.documentDonor?.name || '-';
                    document.getElementById('vendor').value = doc.documentVendor?.name || '-';

                    // Compliance
                    document.getElementById('compliance').value = doc.compliance?.isCompliance ? 'Yes' : 'No';
                    document.getElementById('expiryDate').value = formatDate(doc.compliance?.expiryDate);

                    // Dates
                    document.getElementById('createdAt').value = formatDate(doc.createdAt);
                    document.getElementById('updatedAt').value = formatDate(doc.updatedAt);

                    // Files
                    const fileList = document.getElementById('fileList');
                    const noFiles = document.getElementById('noFiles');
                    fileList.innerHTML = '';
                    if (doc.files && doc.files.length > 0) {
                        doc.files.forEach((f, index) => {
                            const li = document.createElement('li');
                            li.className = 'list-group-item';

                            const fileIcon = getFileIcon(f.originalName);
                            const fileSizeKB = (f.fileSize / 1024).toFixed(1) + ' KB';
                            const displayName = `${f.originalName}${doc.files.length > 1 ? ` +${doc.files.length - 1}` : ''}`;

                            li.innerHTML = `
            <div class="flxtblleft d-flex align-items-center" style="cursor:pointer;">
                <span class="avatar rounded bg-light me-2 mb-2">
                    <img src="${fileIcon}" style="height:30px;" alt="icon">
                </span>
                <div class="flxtbltxt">
                    <p class="fs-14 mb-1 fw-normal">${displayName}</p>
                    <span class="fs-11 fw-light text-black">${fileSizeKB}</span>
                </div>
            </div>
        `;

                            // Redirect to folder view on click
                            li.addEventListener('click', () => {
                                window.location.href = `/folders/view/${f._id}`;
                            });

                            fileList.appendChild(li);
                        });
                        noFiles.style.display = 'none';
                    } else {
                        noFiles.style.display = 'block';
                    }


                    // External Link
                    const link = document.getElementById('externalLink');
                    const linkText = document.getElementById('linkText');
                    if (doc.link) {
                        link.href = doc.link;
                        linkText.textContent = doc.link;
                    } else {
                        link.href = '#';
                        link.classList.add('disabled');
                        linkText.textContent = 'No external link provided';
                    }

                } catch (err) {
                    console.error(err);
                    showToast("Failed to load document version details.", 'error');
                }
            });
        </script>