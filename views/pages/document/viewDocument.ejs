<%- include('../../partials/header') %>

    <div class="page-wrapper">
        <div class="content container-fluid">

            <!-- Breadcrumb -->
            <div class="d-md-flex d-block align-items-center justify-content-between page-breadcrumb mb-4">
                <div class="mb-2 mb-md-0">
                    <h2 class="mb-1 fw-bold">Document Version Details</h2>
                </div>
            </div>

            <div class="card shadow-sm mb-4">
                <div class="card-body">

                    <!-- Expired/Used Message -->
                    <% if (typeof expiredMessage !=='undefined' && expiredMessage) { %>
                        <div class="alert alert-warning">
                            <%= expiredMessage %>
                        </div>
                        <% } %>
                            <!-- Renew Button -->
                            <% if (canRenew) { %>
                                <div class="mb-3">
                                    <button id="renewExpiryBtn" class="btn btn-primary">Renew Expiry</button>
                                </div>
                                <% } %>

                                    <!-- Version & Document Info -->
                                    <form id="documentForm">
                                        <div class="row g-3">
                                            <div class="col-md-4">
                                                <label class="form-label fw-semibold">Project Name</label>
                                                <input type="text" id="projectName" class="form-control" readonly>
                                            </div>
                                            <!-- Add other fields like Department, Project Manager, etc. -->
                                        </div>
                                    </form>

                </div>
            </div>
        </div>
    </div>

    <!-- Renew Modal -->
    <div class="modal fade" id="renewModal" tabindex="-1" aria-labelledby="renewModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="renewModalLabel">Renew Share Expiry</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <label for="renewDuration" class="form-label">Choose Duration:</label>
                    <select id="renewDuration" class="form-select">
                        <option value="oneday">1 Day</option>
                        <option value="oneweek">1 Week</option>
                        <option value="onemonth">1 Month</option>
                        <option value="lifetime">Lifetime</option>
                        <option value="onetime">One-time</option>
                        <option value="custom">Custom (pick date below)</option>
                    </select>
                    <input type="date" id="customExpiry" class="form-control mt-2" style="display:none;">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="confirmRenewBtn" class="btn btn-primary">Renew</button>
                </div>
            </div>
        </div>
    </div>

    <%- include('../../partials/footer') %>

        <script>
            document.addEventListener('DOMContentLoaded', async () => {
                const documentId = "<%= documentId %>";
                const sharedId = "<%= sharedId %>";
                const version = new URLSearchParams(window.location.search).get('version');

                if (!documentId || !version) return;

                // Load document version details
                try {
                    const res = await fetch(`/api/documents/${documentId}/versions/view?version=${version}`);
                    if (!res.ok) throw new Error('Version not found');
                    const data = await res.json();
                    const doc = data.document;
                    const snapshot = doc.snapshot || {};

                    document.getElementById('projectName').value = snapshot.projectName || doc.project?.projectName || '-';
                } catch (err) {
                    console.error(err);
                    alert('Failed to load document details.');
                }

                // Renew button shows modal
                const renewBtn = document.getElementById('renewExpiryBtn');
                const renewModal = new bootstrap.Modal(document.getElementById('renewModal'));
                const renewDuration = document.getElementById('renewDuration');
                const customExpiry = document.getElementById('customExpiry');

                renewDuration.addEventListener('change', () => {
                    customExpiry.style.display = renewDuration.value === 'custom' ? 'block' : 'none';
                });

                renewBtn?.addEventListener('click', () => {
                    renewModal.show();
                });

                // Confirm renewal
                document.getElementById('confirmRenewBtn').addEventListener('click', async () => {
                    let duration = renewDuration.value;
                    let body = { duration };

                    if (duration === 'custom') {
                        const customDate = customExpiry.value;
                        if (!customDate) return alert('Please select a custom expiry date.');
                        body.customDate = customDate;
                    }

                    try {
                        const res = await fetch(`/api/shared/${sharedId}/renew`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(body)
                        });
                        const data = await res.json();

                        if (res.ok) {
                            alert('Expiry renewed successfully!');
                            location.reload();
                        } else {
                            alert(data.message || 'Failed to renew.');
                        }
                    } catch (err) {
                        console.error(err);
                        alert('Server error while renewing expiry.');
                    }
                });
            });
        </script>