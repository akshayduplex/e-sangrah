<%- include('../../partials/header') %>

    <div class="page-wrapper">
        <div class="content">
            <!-- Breadcrumb -->
            <div class="d-flex align-items-center justify-content-between page-breadcrumb mb-3">
                <div class="my-auto mb-2">
                    <h2 class="mb-1">Archived Folders</h2>
                    <nav>
                        <ol class="breadcrumb mb-0">
                            <li class="breadcrumb-item"><a href="#"><i class="ti ti-smart-home"></i></a></li>
                            <li class="breadcrumb-item">Archived Folders</li>
                        </ol>
                    </nav>
                </div>
            </div>

            <!-- Folders Table -->
            <div class="row">
                <div class="col-xxl-12 col-xl-12">
                    <div class="card flex-fill">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table datatable" id="archived_folders_table">
                                    <thead>
                                        <tr>
                                            <th></th>
                                            <th>Folder Name</th>
                                            <th>Owner Name</th>
                                            <th>Owner Email</th>
                                            <th>Department</th>
                                            <th>Project</th>
                                            <th>Status</th>
                                            <th>Created By</th>
                                            <th>Last Modified By</th>
                                        </tr>
                                    </thead>
                                    <tbody id="archived_folders_table_body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <%- include('../../partials/footer') %>
        <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
        <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
        <script>$(document).ready(function () {
                const $table = $('#archived_folders_table');

                const dataTable = $table.DataTable({
                    processing: true,       // show processing indicator
                    serverSide: true,       // enable server-side processing
                    ajax: {
                        url: "http://localhost:5000/api/folders/archived",
                        type: "GET",
                        dataSrc: function (res) {
                            // Map your response to DataTables format
                            // DataTables expects: { data: [...], recordsTotal: x, recordsFiltered: y }
                            if (!res.success) return [];
                            return res.folders.map(folder => ({
                                id: folder._id,
                                actions: `<div class="btn-group" role="group">
                                <a href="#" class="dropdown-item restore-folder" data-folder-id="${folder._id}" data-bs-toggle="modal" data-bs-target="#restore-folder-modal"><i class="ti ti-arrow-back-up"></i></a>
                                <a class="dropdown-item trash-folder" href="#" data-folder-id="${folder._id}" data-bs-toggle="modal" data-bs-target="#trashdoc-modal"><i class="ti ti-trash"></i></a>
                              </div>`,
                                name: folder.name || "-",
                                ownerName: folder.owner?.name || "-",
                                ownerEmail: folder.owner?.email || "-",
                                department: folder.departmentId?.name || "-",
                                project: folder.projectId?.projectName || "-",
                                status: folder.status || "-",
                                createdBy: folder.createdBy?.name || "-",
                                updatedBy: folder.updatedBy?.name || "-"
                            }));
                        }
                    },
                    columns: [
                        { data: 'actions', orderable: false, searchable: false },
                        { data: 'name' },
                        { data: 'ownerName' },
                        { data: 'ownerEmail' },
                        { data: 'department' },
                        { data: 'project' },
                        { data: 'status' },
                        { data: 'createdBy' },
                        { data: 'updatedBy' }
                    ],
                    order: [[1, 'asc']],
                    paging: true,
                    searching: true,
                    ordering: true,
                    info: true,
                    autoWidth: false
                });

                // Handle restore and trash actions
                $(document).on('click', '.trash-folder', function (e) {
                    e.preventDefault();
                    const folderId = $(this).data('folder-id');
                    $('#confirm-trash-folder').off('click').on('click', function () {
                        $.ajax({
                            url: `/api/folders/${folderId}`,
                            type: 'DELETE',
                            success: function (res) {
                                if (res.success) {
                                    dataTable.ajax.reload();
                                }
                            }
                        });
                    });
                });

                $(document).on('click', '.restore-folder', function (e) {
                    e.preventDefault();
                    const folderId = $(this).data('folder-id');
                    $('#confirm-restore-folder').off('click').on('click', function () {
                        $.ajax({
                            url: `/api/folders/${folderId}/restore`,
                            type: 'PATCH',
                            success: function (res) {
                                if (res.success) {
                                    dataTable.ajax.reload();
                                }
                            }
                        });
                    });
                });
            });
        </script>