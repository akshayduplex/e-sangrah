<%- include('../../partials/header') %>
	<!-- Page Wrapper -->
	<div class="page-wrapper">
		<div class="content">
			<!-- Breadcrumb -->
			<div class="d-flex align-items-center justify-content-between page-breadcrumb mb-3">
				<div class="my-auto mb-2">
					<h2 class="mb-1">Recycle Bin</h2>
					<nav>
						<ol class="breadcrumb mb-0">
							<li class="breadcrumb-item">
								<a href="#"><i class="ti ti-smart-home"></i></a>
							</li>
							<li class="breadcrumb-item">
								Recycle Bin
							</li>
						</ol>
					</nav>
				</div>
				<div class="rtbtn">
					<a href="#" data-bs-toggle="modal" data-bs-target="#emptybin-modal"
						class="btn btn-primary btn-lg rounded-pill me-2 mb-2">
						Empty Trash
					</a>
				</div>
			</div>
			<!-- /Breadcrumb -->

			<div class="row">
				<div class="seprate_crdhdr mb-4">
					<div class="d-flex gap-2 align-items-center">
						<div class="dropdown">
							<a href="javascript:void(0);"
								class="dropdown-toggle border text-black btn btn-outline-secondary fs-13 me-2"
								data-bs-toggle="dropdown">
								Select Department
							</a>
							<ul class="dropdown-menu dropdown-menu-end p-3">
								<li>
									<a href="javascript:void(0);" class="dropdown-item rounded-1">UI/UX Designer</a>
								</li>
								<li>
									<a href="javascript:void(0);" class="dropdown-item rounded-1">HR Manager</a>
								</li>
								<li>
									<a href="javascript:void(0);" class="dropdown-item rounded-1">Junior Tester</a>
								</li>
							</ul>
						</div>
					</div>
				</div>
				<div class="col-xxl-12 col-xl-12">
					<div class="card flex-fill">
						<div class="card-body p-0">
							<div class="custom-datatable-filter table-responsive">
								<table class="table datatable">
									<thead>
										<tr>
											<th></th>
											<th>Files</th>
											<th>Created on</th>
											<th>Department</th>
											<th>Deleted On</th>
											<th>Actions</th>
										</tr>
									</thead>
									<tbody>
										<% documents.forEach(doc=> { %>
											<tr>
												<!-- Checkbox for selecting document -->
												<td>
													<div class="form-check form-check-md">
														<input class="form-check-input select-document" type="checkbox"
															data-document-id="<%= doc._id %>">
													</div>
												</td>

												<!-- List all files within the document -->
												<td>
													<% doc.files.forEach(file=> { %>
														<div class="flxtblleft mb-1">
															<span class="avatar rounded bg-light mb-2">
																<img src="/img/icons/fn1.png">
															</span>
															<div class="flxtbltxt">
																<p class="fs-14 mb-1 fw-normal text-neutral">
																	<%= file.originalName %>
																</p>
																<span class="fs-11 fw-light text-black">
																	<%= (file.fileSize / 1024).toFixed(2)%> KB
																</span>
															</div>
														</div>
														<% }) %>
												</td>

												<!-- Created date -->
												<td>
													<p class="tbl_date">
														<%= new Date(doc.createdAt).toLocaleDateString() %>
															&nbsp;&nbsp;
															<%= new Date(doc.createdAt).toLocaleTimeString() %>
													</p>
												</td>

												<!-- Department -->
												<td>
													<p>
														<%= doc.department?.name || '-' %>
													</p>
												</td>

												<!-- Deleted date -->
												<td>
													<p class="tbl_date">
														<%= new Date(doc.deletedAt).toLocaleDateString() %>
															&nbsp;&nbsp;
															<%= new Date(doc.deletedAt).toLocaleTimeString() %>
													</p>
												</td>

												<!-- Actions -->
												<td>
													<div class="action-icon d-inline-flex">
														<!-- Restore document -->
														<a href="#" data-bs-toggle="modal"
															data-bs-target="#restore-modal" class="me-2">
															<i class="ti ti-restore"></i>
														</a>

														<!-- Permanent delete document -->
														<a href="#" class="delete-permanent-btn"
															data-document-id="<%= doc._id %>"
															data-document-name="Document">
															<i class="ti ti-trash"></i>
														</a>
													</div>
												</td>
											</tr>
											<% }) %>
									</tbody>
								</table>
							</div>

						</div>
					</div>
				</div>
				<!-- /Projects -->
			</div>

		</div>

		<div class="footer mt-4 d-sm-flex align-items-center justify-content-between border-top bg-white p-3">
			<p class="mb-0">2025 &copy; HLFPPT.</p>
			<p>Designed & Developed by <a href="javascript:void(0);" class="text-primary">Duplex services &
					Technology</a></p>
		</div>

	</div>
	<!-- /Page Wrapper -->


	<%- include('../../partials/footer') %>
		<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
		<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
		<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
		<script>
			$(document).ready(function () {
				// Function to format bytes to MB
				function formatBytesToMB(bytes) {
					return (bytes / 1024).toFixed(2) + ' MB';
				}
				let documentIdToDelete = null;
				let documentIdToRestore = null;

				// Empty Recycle Bin
				$('[data-bs-target="#emptybin-modal"]').on('click', function () {
					const modal = $('#emptybin-modal');
					const confirmBtn = modal.find('button.btn-primary');

					// Collect all document IDs and calculate total size
					const docIds = [];
					let totalSizeKB = 0;

					$('.select-document').each(function () {
						const row = $(this).closest('tr');
						const docId = $(this).data('document-id');
						if (docId) docIds.push(docId);

						row.find('td:nth-child(2) .flxtbltxt span').each(function () {
							const sizeText = $(this).text().trim(); // e.g., "190 KB"
							const sizeValue = parseFloat(sizeText.replace('KB', '').trim());
							if (!isNaN(sizeValue)) totalSizeKB += sizeValue;
						});
					});

					const totalSizeMB = formatBytesToMB(totalSizeKB);

					modal.find('.modal-body').html(`
        Are you sure you want to permanently 
        <span class="txtblue">delete all files</span> in the recycle bin 
        (${totalSizeMB})? This action cannot be undone.
    `);

					confirmBtn.off('click').on('click', function () {
						if (docIds.length === 0) {
							showToast('No documents to delete.', 'error');
							modal.modal('hide');
							return;
						}

						$.ajax({
							url: '/api/documents/permanent', // Use the backend route
							method: 'DELETE',
							contentType: 'application/json',
							data: JSON.stringify({ ids: docIds }),
							success: function (res) {
								modal.modal('hide');
								// Remove all rows from the table dynamically
								$('.datatable tbody').empty();
								showToast(res.message || 'Recycle Bin emptied successfully.', 'success');
							},
							error: function (err) {
								console.error(err);
								showToast('Failed to empty Recycle Bin.', 'error');
							}
						});
					});

					modal.modal('show');
				});

				// Restore document
				$('.ti-restore').closest('a').on('click', function (e) {
					e.preventDefault();

					const row = $(this).closest('tr');
					documentIdToRestore = row.find('.select-document').data('document-id');

					// Get file info from the row
					const files = [];
					row.find('td:nth-child(2) .flxtblleft').each(function () {
						const fileName = $(this).find('.flxtbltxt p').text().trim();
						const fileSize = $(this).find('.flxtbltxt span').text().trim();
						files.push({ name: fileName, size: fileSize });
					});

					// Update modal content dynamically
					const modal = $('#restore-modal');
					const fileListHtml = files.map(f => `
            <div class="flxtblleft mb-1">
                <span class="avatar rounded bg-light mb-2">
                    <img src="/img/icons/fn1.png">
                </span>
                <div class="flxtbltxt">
                    <p class="fs-14 mb-1 fw-normal text-neutral">${f.name}</p>
                    <span class="fs-11 fw-light text-black">${f.size}</span>
                </div>
            </div>
        `).join('');

					modal.find('.flxtblleft').parent().html(fileListHtml);

					// Show modal
					modal.modal('show');

					// Handle restore button
					modal.find('button.btn-primary').off('click').on('click', function () {
						if (!documentIdToRestore) return;
						$.ajax({
							url: `/api/documents/${documentIdToRestore}/restore`,
							method: 'PATCH',
							success: function () {
								modal.modal('hide');
								// Remove the restored row from the table
								row.remove();
								showToast('Document has been restored successfully.', 'success');
							},
							error: function (err) {
								console.error('Restore failed:', err);
								showToast('Failed to restore document. Please try again.', 'error');
							}
						});
					});
				});

				// Permanent delete without full page reload
				$('.delete-permanent-btn').on('click', function (e) {
					e.preventDefault();

					const row = $(this).closest('tr');
					const documentIdToDelete = $(this).data('document-id');
					const documentName = $(this).data('document-name');

					const modal = $('#trashdoc-modal');
					modal.find('.modal-title').html(`
            <img src="/img/icons/bin.png"> <br> Permanent Delete
        `);
					modal.find('.modal-body').html(`
            Are you sure you want to permanently 
            <span class="txtblue">delete "${documentName}"</span>? 
            This action cannot be undone.
        `);

					const confirmBtn = modal.find('#confirm-trash-folder');
					confirmBtn.off('click').on('click', function () {
						$.ajax({
							url: `/api/documents/permanent`,
							method: 'DELETE',
							contentType: 'application/json',
							data: JSON.stringify({ ids: [documentIdToDelete] }),
							success: function () {
								modal.modal('hide');
								// Remove the deleted row from the table
								row.remove();
								showToast(`"${documentName}" has been permanently deleted.`, 'success');
							},
							error: function () {
								showToast('Failed to delete document. Please try again.', 'error');
							}
						});
					});

					modal.modal('show');
				});

			});

		</script>