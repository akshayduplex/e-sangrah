<%- include('../../partials/header') %>
	<!-- Page Wrapper -->
	<div class="page-wrapper">
		<div class="content">
			<!-- Breadcrumb -->
			<div class="d-flex align-items-center justify-content-between page-breadcrumb mb-3">
				<div class="my-auto mb-2">
					<h2 class="mb-1">Recycle Bin</h2>
					<nav>
						<ol class="breadcrumb mb-0">
							<li class="breadcrumb-item">
								<a href="#"><i class="ti ti-smart-home"></i></a>
							</li>
							<li class="breadcrumb-item">
								Recycle Bin
							</li>
						</ol>
					</nav>
				</div>
				<div class="rtbtn">
					<a href="#" data-bs-toggle="modal" data-bs-target="#emptybin-modal"
						class="btn btn-primary btn-lg rounded-pill me-2 mb-2">
						Empty Trash
					</a>
				</div>
			</div>
			<!-- /Breadcrumb -->

			<div class="row">
				<div class="seprate_crdhdr mb-4">
					<div class="d-flex gap-2 align-items-center">
						<div class="dropdown">
							<a href="javascript:void(0);"
								class="dropdown-toggle border text-black btn btn-outline-secondary fs-13 me-2"
								data-bs-toggle="dropdown">
								Select Department
							</a>
							<ul class="dropdown-menu dropdown-menu-end p-3">
								<li>
									<a href="javascript:void(0);" class="dropdown-item rounded-1">UI/UX Designer</a>
								</li>
								<li>
									<a href="javascript:void(0);" class="dropdown-item rounded-1">HR Manager</a>
								</li>
								<li>
									<a href="javascript:void(0);" class="dropdown-item rounded-1">Junior Tester</a>
								</li>
							</ul>
						</div>
					</div>
				</div>
				<div class="col-xxl-12 col-xl-12">
					<div class="card flex-fill">
						<div class="card-body p-0">
							<div class="custom-datatable-filter table-responsive">
								<table class="table datatable">
									<thead>
										<tr>
											<th></th>
											<th>Files</th>
											<th>Created on</th>
											<th>Department</th>
											<th>Deleted On</th>
											<th>Actions</th>
										</tr>
									</thead>
									<tbody>
										<% documents.forEach(doc=> { %>
											<tr>
												<!-- Checkbox for selecting document -->
												<td>
													<div class="form-check form-check-md">
														<input class="form-check-input select-document" type="checkbox"
															data-document-id="<%= doc._id %>">
													</div>
												</td>

												<!-- List all files within the document -->
												<td>
													<% doc.files.forEach(file=> { %>
														<div class="flxtblleft mb-1">
															<span class="avatar rounded bg-light mb-2">
																<img src="assets/img/icons/fn1.png">
															</span>
															<div class="flxtbltxt">
																<p class="fs-14 mb-1 fw-normal text-neutral">
																	<%= file.originalName %>
																</p>
																<span class="fs-11 fw-light text-black">
																	<%= file.fileSize %> KB
																</span>
															</div>
														</div>
														<% }) %>
												</td>

												<!-- Created date -->
												<td>
													<p class="tbl_date">
														<%= new Date(doc.createdAt).toLocaleDateString() %>
															&nbsp;&nbsp;
															<%= new Date(doc.createdAt).toLocaleTimeString() %>
													</p>
												</td>

												<!-- Department -->
												<td>
													<p>
														<%= doc.department?.name || '-' %>
													</p>
												</td>

												<!-- Deleted date -->
												<td>
													<p class="tbl_date">
														<%= new Date(doc.deletedAt).toLocaleDateString() %>
															&nbsp;&nbsp;
															<%= new Date(doc.deletedAt).toLocaleTimeString() %>
													</p>
												</td>

												<!-- Actions -->
												<td>
													<div class="action-icon d-inline-flex">
														<!-- Restore document -->
														<a href="#" data-bs-toggle="modal"
															data-bs-target="#restore-modal" class="me-2">
															<i class="ti ti-restore"></i>
														</a>

														<!-- Permanent delete document -->
														<a href="#" class="delete-permanent-btn"
															data-document-id="<%= doc._id %>"
															data-document-name="Document">
															<i class="ti ti-trash"></i>
														</a>
													</div>
												</td>
											</tr>
											<% }) %>
									</tbody>
								</table>
							</div>

						</div>
					</div>
				</div>
				<!-- /Projects -->
			</div>

		</div>

		<div class="footer mt-4 d-sm-flex align-items-center justify-content-between border-top bg-white p-3">
			<p class="mb-0">2025 &copy; HLFPPT.</p>
			<p>Designed & Developed by <a href="javascript:void(0);" class="text-primary">Duplex services &
					Technology</a></p>
		</div>

	</div>
	<!-- /Page Wrapper -->


	<%- include('../../partials/footer') %>
		<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
		<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
		<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
		<script>
			$(document).ready(function () {

				let documentIdToDelete = null;

				// When trash icon is clicked
				$('.delete-permanent-btn').on('click', function (e) {
					e.preventDefault();

					// âœ… Use document ID now
					const documentId = $(this).data('document-id');
					const documentName = $(this).data('document-name'); // optional for modal display

					documentIdToDelete = documentId;

					// Update modal title and body
					const modal = $('#emptybin-modal');
					modal.find('.modal-title').text('Permanent Delete');
					modal.find('.modal-body').html(`
            Are you sure you want to permanently 
            <span class="txtblue">delete "${documentName}"</span>? 
            This action cannot be undone.
        `);

					// Update confirm button
					const confirmBtn = modal.find('.modal-footer button[type="submit"]');
					confirmBtn.text('Yes, Delete');
					confirmBtn.removeClass('btn-primary').addClass('btn-danger');

					// Remove previous click handlers
					confirmBtn.off('click').on('click', function () {
						if (!documentIdToDelete) return;

						$.ajax({
							url: `/api/documents/permanent?id=${documentIdToDelete}`,
							method: 'DELETE',
							success: function (response) {
								modal.modal('hide');
								alert(`"${documentName}" has been permanently deleted.`);
								location.reload(); // or remove the row dynamically
							},
							error: function (err) {
								console.error('Permanent delete failed:', err);
								alert('Failed to delete document. Please try again.');
							}
						});
					});

					// Show the modal
					modal.modal('show');
				});

			});
		</script>