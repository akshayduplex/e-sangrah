<%- include('../partials/header') %>

	<div class="page-wrapper">
		<div class="content">
			<!-- Breadcrumb -->
			<div class="d-flex align-items-center justify-content-between page-breadcrumb mb-3">
				<div class="my-auto mb-2">
					<h2 class="mb-1">My Profile</h2>
					<nav>
						<ol class="breadcrumb mb-0">
							<li class="breadcrumb-item"><a href="#"><i class="ti ti-smart-home"></i></a></li>
							<li class="breadcrumb-item">My Profile</li>
						</ol>
					</nav>
				</div>
			</div>
			<!-- /Breadcrumb -->

			<div class="profile-card dflexbtwn mb-4">
				<div class="d-flex align-items-center">
					<span class="avatar avatar-lg me-3 avatar-rounded">
						<img id="profileImage" src="" alt="img"
							style="width:60px; height:60px; object-fit:cover; border-radius:50%;">

					</span>
					<div>
						<h6 class="mb-0" id="profileName">Guest</h6>
						<small class="text-muted" id="profileDesignation">Manager</small>
					</div>
				</div>
				<button class="btn btn-primary" onclick="toggleProfile()">Edit Profile</button>
			</div>

			<!-- View Mode -->
			<div id="viewProfile">
				<div class="row g-4">
					<div class="col-md-12 profileview_fields">
						<div class="label">Name:</div>
						<div class="value" id="viewName"></div>
					</div>
					<div class="col-md-12 profileview_fields">
						<div class="label">Email:</div>
						<div class="value" id="viewEmail"></div>
					</div>
					<div class="col-md-12 profileview_fields">
						<div class="label">Phone Number:</div>
						<div class="value" id="viewPhone"></div>
					</div>
					<div class="col-md-12 profileview_fields">
						<div class="label">Status:</div>
						<div class="value" id="viewStatus"></div>
					</div>
					<div class="col-md-12 profileview_fields">
						<div class="label">Profile Type:</div>
						<div class="value" id="viewProfileType"></div>
					</div>
					<div class="col-md-12 profileview_fields">
						<div class="label">Position:</div>
						<div class="value" id="viewPosition"></div>
					</div>
					<div class="col-md-12 profileview_fields">
						<div class="label">Address</div>
						<div class="value" id="viewAddress"></div>
					</div>
					<div class="col-md-12 profileview_fields">
						<div class="label">Created On:</div>
						<div class="value" id="viewCreatedAt"></div>
					</div>
					<div class="col-md-12 profileview_fields">
						<div class="label">Updated On:</div>
						<div class="value" id="viewUpdatedAt"></div>
					</div>
				</div>
			</div>

			<!-- Edit Mode -->
			<div id="editProfile" style="display:none;">
				<form id="editProfileForm" enctype="multipart/form-data">
					<div class="row g-4">
						<!-- Editable fields -->
						<div class="col-md-6">
							<label class="form-label">Name</label>
							<input type="text" name="name" class="form-control" id="inputName" required>
						</div>
						<div class="col-md-6">
							<label class="form-label">Email</label>
							<input type="email" name="email" class="form-control" id="inputEmail" required>
						</div>
						<div class="col-md-6">
							<label class="form-label">Phone Number</label>
							<input type="text" name="phone_number" class="form-control" id="inputPhone">
						</div>
						<div class="col-md-6">
							<label class="form-label">Address</label>
							<input type="text" name="address" class="form-control" id="inputAddress">
						</div>
						<div class="col-12">
							<label class="form-label">Profile Image</label>
							<input type="file" name="profile_image" class="form-control" id="inputProfileImage">
						</div>

						<!-- Read-only fields -->
						<div class="col-md-6">
							<label class="form-label">Status</label>
							<input type="text" class="form-control" id="inputStatus" disabled>
						</div>
						<div class="col-md-6">
							<label class="form-label">Profile Type</label>
							<input type="text" class="form-control" id="inputProfileType" disabled>
						</div>
						<div class="col-md-6">
							<label class="form-label">Created on</label>
							<input type="text" class="form-control" id="inputCreatedAt" disabled>
						</div>
						<div class="col-md-6">
							<label class="form-label">Updated on</label>
							<input type="text" class="form-control" id="inputUpdatedAt" disabled>
						</div>
					</div>

					<div class="d-flex justify-content-end mt-4 mb-4">
						<button type="button" class="btn btn-light me-2" onclick="toggleProfile()">Cancel</button>
						<button type="submit" class="btn btn-primary">Update</button>
					</div>
				</form>
			</div>

		</div>
	</div>

	<%- include('../partials/footer') %>
		<script>
			const toggleProfile = () => {
				const view = document.getElementById('viewProfile');
				const edit = document.getElementById('editProfile');
				view.style.display = view.style.display === "none" ? "block" : "none";
				edit.style.display = edit.style.display === "none" ? "block" : "none";
			};

			const loadProfile = () => {
				fetch(`${baseUrl}/api/auth/profile`, { credentials: 'include' })
					.then(res => res.json())
					.then(data => {
						if (!data.success || !data.user) {
							toggleProfile(); // No profile â†’ show form
							return;
						}
						const user = data.user;


						// Header & avatar
						document.getElementById('profileName').textContent = user.name;
						document.getElementById('profileDesignation').textContent = user.userDetails.designation.name || "Guest";
						document.getElementById('profileImage').src = user.profile_image || '/img/profiles/avatar-12.jpg';

						// Editable fields
						document.getElementById('inputName').value = user.name;
						document.getElementById('inputEmail').value = user.email;
						document.getElementById('inputPhone').value = user.phone_number || '';
						document.getElementById('inputAddress').value = user.address || ''; // <-- Add this line

						// Read-only fields
						document.getElementById('inputStatus').value = user.status || '';
						document.getElementById('inputProfileType').value = user.profile_type || '';
						document.getElementById('inputCreatedAt').value = formatDateDDMMYYYY(user.createdAt);
						document.getElementById('inputUpdatedAt').value = formatDateDDMMYYYY(user.updatedAt);

						// View mode display
						document.getElementById('viewName').textContent = user.name;
						document.getElementById('viewEmail').textContent = user.email;
						document.getElementById('viewPhone').textContent = user.phone_number || '';
						document.getElementById('viewStatus').textContent = user.status || '';
						document.getElementById('viewProfileType').textContent = user.profile_type || '';
						document.getElementById('viewPosition').textContent = user.userDetails.designation.name || '';
						document.getElementById('viewAddress').textContent = user.address || '';
						document.getElementById('viewCreatedAt').textContent = formatDateDDMMYYYY(user.createdAt);
						document.getElementById('viewUpdatedAt').textContent = formatDateDDMMYYYY(user.updatedAt);

					})
					.catch(err => {
						showToast('Failed to load profile', 'error');
					});
			};

			// Update profile via AJAX
			document.getElementById('editProfileForm').addEventListener('submit', (e) => {
				e.preventDefault();
				const formData = new FormData(e.target);

				fetch(`${baseUrl}/api/auth/edit-profile`, {
					method: 'PATCH',
					credentials: 'include',
					body: formData
				})
					.then(res => res.json())
					.then(data => {
						if (!data.success) throw new Error(data.message);
						showToast('Profile updated successfully', 'success');
						toggleProfile();
						loadProfile();
					})
					.catch(err => {
						showToast('Failed to update profile', 'error');
					});
			});

			// Live preview for profile image
			document.getElementById('inputProfileImage').addEventListener('change', (e) => {
				const file = e.target.files[0];
				if (file) {
					const reader = new FileReader();
					reader.onload = () => document.getElementById('profileImage').src = reader.result;
					reader.readAsDataURL(file);
				}
			});

			// Load profile on page load
			loadProfile();
		</script>