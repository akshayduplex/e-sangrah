<%- include('../../partials/header') %>

    <div class="page-wrapper">
        <div class="content">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h4 class="mb-0">Assign Menu</h4>
                        </div>
                        <div class="card-body">
                            <form id="assignMenuForm" novalidate>
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <label for="designation_id" class="form-label">Designation</label>
                                        <select class="form-select" id="designation_id" name="designation_id" required>
                                            <option value="">-- Select Designation --</option>
                                            <% if (Array.isArray(designations) && designations.length> 0) { %>
                                                <% designations.forEach(designation=> { %>
                                                    <option value="<%= designation._id %>">
                                                        <%= designation.name %>
                                                    </option>
                                                    <% }) %>
                                                        <% } %>
                                        </select>
                                    </div>
                                    <div class="col-md-6 d-flex align-items-end">
                                        <button type="button" id="btnSelectAll" class="btn btn-outline-primary me-2">
                                            <i class="fas fa-check-square"></i> Select All
                                        </button>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-12">
                                        <h5 class="mb-3">Menus</h5>
                                        <div class="menu-container">
                                            <% if (Array.isArray(masterMenus) && masterMenus.length> 0) { %>
                                                <% masterMenus.forEach(master=> { %>
                                                    <div class="menu-item">
                                                        <div class="form-check">
                                                            <input class="form-check-input master-checkbox"
                                                                type="checkbox" value="<%= master._id.toString() %>"
                                                                id="master_<%= master._id %>">
                                                            <label class="form-check-label fw-bold"
                                                                for="master_<%= master._id %>">
                                                                <i class="fas fa-folder me-1"></i>
                                                                <%= master.name %>
                                                            </label>
                                                        </div>

                                                        <% if (Array.isArray(master.children) && master.children.length>
                                                            0) { %>
                                                            <div class="submenu-items ms-4">
                                                                <% master.children.forEach(menu=> { %>
                                                                    <div class="form-check">
                                                                        <input class="form-check-input menu-checkbox"
                                                                            type="checkbox"
                                                                            value="<%= menu._id.toString() %>"
                                                                            id="menu_<%= menu._id %>">
                                                                        <label class="form-check-label"
                                                                            for="menu_<%= menu._id %>">
                                                                            <i class="fas fa-file me-1"></i>
                                                                            <%= menu.name %>
                                                                        </label>
                                                                    </div>

                                                                    <% if (Array.isArray(menu.children) &&
                                                                        menu.children.length> 0) { %>
                                                                        <div class="sub-submenu-items ms-4">
                                                                            <% menu.children.forEach(submenu=> { %>
                                                                                <div class="form-check">
                                                                                    <input
                                                                                        class="form-check-input menu-checkbox"
                                                                                        type="checkbox"
                                                                                        value="<%= submenu._id.toString() %>"
                                                                                        id="submenu_<%= submenu._id %>">
                                                                                    <label class="form-check-label"
                                                                                        for="submenu_<%= submenu._id %>">
                                                                                        <i
                                                                                            class="fas fa-file-alt me-1"></i>
                                                                                        <%= submenu.name %>
                                                                                    </label>
                                                                                </div>
                                                                                <% }) %>
                                                                        </div>
                                                                        <% } %>
                                                                            <% }) %>
                                                            </div>
                                                            <% } %>
                                                    </div>
                                                    <% }) %>
                                                        <% } else { %>
                                                            <p class="text-muted">No menus found.</p>
                                                            <% } %>

                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-end mt-4">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-1"></i> Save Assignment
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <%- include('../../partials/footer') %>

        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const designationSelect = document.getElementById('designation_id');
                const assignMenuForm = document.getElementById('assignMenuForm');
                const selectAllBtn = document.getElementById('btnSelectAll');
                const allCheckboxes = () => assignMenuForm.querySelectorAll('input[type="checkbox"]');

                let assignedMenus = [];

                // --- Load assigned menus ---
                designationSelect.addEventListener('change', async function () {
                    const designationId = this.value;
                    assignedMenus = [];

                    allCheckboxes().forEach(cb => (cb.checked = false));
                    if (!designationId) return;

                    try {
                        const res = await fetch(`/api/assign-menu/designation/${designationId}/menus`);
                        const data = await res.json();

                        assignedMenus = data.success && Array.isArray(data.data) ? data.data : [];
                        assignedMenus.forEach(menuId => {
                            const cb = assignMenuForm.querySelector(`input[value="${menuId}"]`);
                            if (cb) cb.checked = true;
                        });
                    } catch (err) {
                        console.error(err);
                        showToast('Failed to fetch assigned menus.', "error");
                    }
                });

                // --- Select All toggle ---
                selectAllBtn.addEventListener('click', () => {
                    const boxes = Array.from(allCheckboxes());
                    const allChecked = boxes.every(cb => cb.checked);
                    boxes.forEach(cb => (cb.checked = !allChecked));
                });

                // --- Save assignment ---
                assignMenuForm.addEventListener('submit', async e => {
                    e.preventDefault();

                    const designationId = designationSelect.value;
                    if (!designationId) return showToast('Please select a designation first.', "warning");

                    const selected = Array.from(allCheckboxes())
                        .filter(cb => cb.checked)
                        .map(cb => cb.value);

                    const toAssign = selected.filter(id => !assignedMenus.includes(id));
                    const toUnassign = assignedMenus.filter(id => !selected.includes(id));

                    if (toAssign.length === 0 && toUnassign.length === 0) {
                        return showToast('No changes to save.', "info");
                    }

                    try {
                        const requests = [];

                        if (toAssign.length > 0) {
                            requests.push(fetch('/api/assign-menu/assign', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ designation_id: designationId, menu_ids: toAssign })
                            }));
                        }

                        if (toUnassign.length > 0) {
                            requests.push(fetch('/api/assign-menu/unselect', {
                                method: 'DELETE',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ designation_id: designationId, menu_ids: toUnassign })
                            }));
                        }

                        const responses = await Promise.all(requests);
                        const results = await Promise.all(responses.map(r => r.json()));

                        const failed = results.filter(r => !r.success);

                        if (failed.length === 0) {
                            assignedMenus = selected;
                            showToast('Menu assignments successfully!', 'success', 1000);
                            setTimeout(() => window.location.reload(), 1200);

                        } else {
                            console.error("Assignment API errors:", failed);
                            showToast(`Some requests failed: ${failed.map(f => f.message).join(", ")}`, "error");
                        }

                    } catch (err) {
                        console.error(err);
                        showToast('Error updating menus.', 'error');
                    }
                });
            });
        </script>