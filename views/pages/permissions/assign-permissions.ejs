<%- include('../../partials/header') %>
	<div class="page-wrapper">
		<div class="content">
			<!-- Breadcrumb -->
			<div class="d-flex align-items-center justify-content-between page-breadcrumb mb-3">
				<div class="my-auto mb-2">
					<h2 class="mb-1">Assign Permissions</h2>
					<nav>
						<ol class="breadcrumb mb-0">
							<li class="breadcrumb-item">
								<a href="#"><i class="ti ti-smart-home"></i></a>
							</li>
							<li class="breadcrumb-item">Assign Permissions</li>
						</ol>
					</nav>
				</div>
				<div class="rtbtn">
					<a href="#" class="btn btn-primary btn-lg rounded-pill me-2 mb-2" data-bs-toggle="modal"
						data-bs-target="#roleuser-modal">
						<i class="ti ti-plus me-1"></i>Add Role User
					</a>
				</div>
			</div>

			<div class="row">
				<div class="seprate_crdhdr mb-4">
					<div class="d-flex gap-2 align-items-center">
						<!-- ✅ Role Filter -->
						<div>
							<select id="roleFilter" class="form-select">
								<option value="">-- Select Role --</option>
								<% profile_type.forEach(type=> { %>
									<option value="<%= type %>">
										<%= type.charAt(0).toUpperCase() + type.slice(1).toLowerCase() %>
									</option>
									<% }) %>
							</select>
						</div>

						<div class="input-icon-end position-relative">
							<input type="text" class="form-control datetimepicker" placeholder="dd/mm/yyyy"
								value="02-05-2024">
							<span class="input-icon-addon">
								<i class="ti ti-calendar text-gray-7"></i>
							</span>
						</div>
					</div>
				</div>

				<!-- ✅ Users Table -->
				<div class="card" id="userListCard">
					<div class="card-body p-0" id="userListBody">
						<div class="custom-datatable-filter table-responsive" id="userTableWrapper">
							<table id="usersTable" class="table datatable">
								<thead>
									<tr>
										<th></th> <!-- Settings column -->
										<th>Name</th>
										<th>Email</th>
										<th>Designation</th>
										<th>Department</th>
										<th>Created on</th>
										<th>Assign Permission</th>
									</tr>
								</thead>
								<tbody></tbody>
							</table>
						</div>
					</div>
				</div>
			</div>

		</div>

		<div class="footer mt-4 d-sm-flex align-items-center justify-content-between border-top bg-white p-3">
			<p class="mb-0">2025 &copy; HLFPPT.</p>
			<p>Designed & Developed by <a href="javascript:void(0);" class="text-primary">Duplex services &
					Technology</a></p>
		</div>
	</div>

	<!-- ✅ Role User Modal -->
	<div id="roleuser-modal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered modal-lg">
			<div class="modal-content">
				<div class="modal-header border-0 pb-0">
					<h5 class="modal-title fw-medium fs-24 text-black">Add Role User</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body pt-0">
					<form class="row mt-4 px-3" action="#">
						<div class="col-sm-6 mb-3">
							<label for="username" class="form-label">Name</label>
							<input class="form-control" type="text" id="username" required placeholder="Enter name">
						</div>
						<div class="col-sm-6 mb-3">
							<label for="userType" class="form-label">Choose User Type</label>
							<select id="userType" class="form-select">
								<% profile_type.forEach(type=> { %>
									<option value="<%= type %>">
										<%= type.charAt(0).toUpperCase() + type.slice(1).toLowerCase() %>
									</option>
									<% }) %>
							</select>
						</div>
						<div class="col-sm-6 mb-3">
							<label class="form-label">Designation</label>
							<select id="designation" name="designation" class="form-select select2" required>
								<option value="">-- Select Designation --</option>
								<% if (designations && designations.length) { %>
									<% designations.forEach(des=> { %>
										<option value="<%= des._id %>">
											<%= des.name %>
										</option>
										<% }) %>
											<% } else { %>
												<option disabled>No designations available</option>
												<% } %>
							</select>
						</div>
						<div class="col-sm-6 mb-3">
							<label class="form-label">Department</label>
							<select id="department" name="department" class="form-select select2" required>
								<option value="">-- Select Department --</option>
								<% if (departments && departments.length) { %>
									<% departments.forEach(dep=> { %>
										<option value="<%= dep._id %>">
											<%= dep.name %>
										</option>
										<% }) %>
											<% } else { %>
												<option disabled>No departments available</option>
												<% } %>
							</select>
						</div>
						<div class="col-sm-6 mb-3">
							<button class="btn btn-primary rounded-pill px-4" type="submit">Save</button>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>

	<%- include('../../partials/footer') %>
		<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
		<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
		<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
		<script>
			$(document).ready(function () {
				// ✅ Default role = "user"
				let selectedRole = "user";
				$("#roleFilter").val("user"); // preselect dropdown

				const table = $('#usersTable').DataTable({
					processing: true,
					serverSide: false,
					ajax: {
						url: `/api/user?profile_type=${selectedRole}`,
						xhrFields: { withCredentials: true },
						dataSrc: function (json) {
							return json.users || [];
						}
					},
					columns: [
						{
							data: "_id",
							render: function (id) {
								return `
							<div class="btn-group" role="group">
								<button type="button" class="btn border-0" data-bs-toggle="dropdown" aria-expanded="false">
									<i class="ti ti-settings"></i>
								</button>
								<ul class="dropdown-menu">
									<li><a class="dropdown-item" href="/user/${id}"><i class="ti ti-eye"></i> View</a></li>
									<li><a class="dropdown-item" href="/user/edit/${id}"><i class="ti ti-pencil-minus"></i> Edit</a></li>
								</ul>
							</div>`;
							}
						},
						{ data: "name" },
						{ data: "email" },
						{ data: "userDetails.designation.name", defaultContent: "-" },
						{ data: "userDetails.department.name", defaultContent: "-" },
						{
							data: "createdAt",
							render: function (data) {
								if (!data) return "-";
								const d = new Date(data);
								return `${d.toLocaleDateString("en-GB")} &nbsp; ${d.toLocaleTimeString("en-GB", {
									hour: "2-digit",
									minute: "2-digit"
								})}`;
							}
						},
						{
							data: "_id",
							render: function (id) {
								return `<a href="/user-permissions/${id}" class="btn btn-sm btn-primary">Assign</a>`;
							}
						}
					]
				});

				// ✅ Role filter change event
				$("#roleFilter").on("change", function () {
					selectedRole = $(this).val() || "user";
					table.ajax.url(`/api/user?profile_type=${selectedRole}`).load();
				});
			});
		</script>