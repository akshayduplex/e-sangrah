<%- include('../../partials/header') %>

    <div class="page-wrapper">
        <div class="content">

            <!-- Breadcrumb -->
            <div class="d-flex align-items-center justify-content-between page-breadcrumb mb-3">
                <div class="my-auto mb-2">
                    <h2 class="mb-1">
                        <%= project.projectName %>
                    </h2>
                    <nav>
                        <ol class="breadcrumb mb-0">
                            <li class="breadcrumb-item"><a href="#"><i class="ti ti-smart-home"></i></a></li>
                            <li class="breadcrumb-item">Dashboard</li>
                            <li class="breadcrumb-item">Project List</li>
                            <li class="breadcrumb-item active">
                                <%= project.projectName %>
                            </li>
                        </ol>
                    </nav>
                </div>
                <div class="rtbtn">
                    <a href="/projects/<%= project._id %>/project-details"
                        class="btn btn-primary btn-lg rounded-pill me-2 mb-2">
                        <i class="ti ti-arrow-left me-1"></i> Back to Details
                    </a>
                </div>
            </div>
            <!-- /Breadcrumb -->

            <!-- Edit Project Form -->
            <div class="project-details card shadow-sm p-4">
                <form id="editProjectForm">

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label><strong>Project Name</strong></label>
                            <input type="text" name="projectName" class="form-control"
                                value="<%= project.projectName %>">
                        </div>
                        <div class="col-md-6">
                            <label><strong>Project Code/ID</strong></label>
                            <input type="text" name="projectCode" class="form-control"
                                value="<%= project.projectCode %>">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label><strong>Project Type</strong></label>
                            <input type="text" name="projectType" class="form-control"
                                value="<%= project.projectType %>">
                        </div>

                        <div class="col-md-6">
                            <label><strong>Project Manager</strong></label>
                            <select name="projectManager" class="form-control">
                                <% users.forEach(user=> { %>
                                    <option value="<%= user._id %>"
                                        <%=project.projectManager._id.toString()===user._id.toString() ? "selected" : ""
                                        %>>
                                        <%= user.name %>
                                    </option>
                                    <% }) %>
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label><strong>Department</strong></label>
                            <select name="department" class="form-control">
                                <% departments.forEach(dep=> { %>
                                    <option value="<%= dep._id %>"
                                        <%=project.department._id.toString()===dep._id.toString() ? "selected" : "" %>>
                                        <%= dep.name %>
                                    </option>
                                    <% }) %>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label><strong>Start Date</strong></label>
                            <input type="date" name="projectStartDate" class="form-control"
                                value="<%= project.projectStartDate ? project.projectStartDate.toISOString().substring(0,10) : '' %>">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label><strong>End Date</strong></label>
                            <input type="date" name="projectEndDate" class="form-control"
                                value="<%= project.projectEndDate ? project.projectEndDate.toISOString().substring(0,10) : '' %>">
                        </div>
                        <div class="col-md-6">
                            <label><strong>Project Description</strong></label>
                            <textarea name="projectDescription" class="form-control"
                                rows="4"><%= project.projectDescription %></textarea>
                        </div>
                    </div>

                    <div class="text-end">
                        <button type="submit" class="btn btn-primary btn-lg rounded-pill">
                            <i class="ti ti-check me-1"></i> Update Project
                        </button>
                    </div>

                </form>
            </div>
            <!-- /Edit Project Form -->

        </div>

        <!-- Footer -->
        <footer class="footer mt-4 d-sm-flex align-items-center justify-content-between border-top bg-white p-3">
            <p class="mb-0">2025 &copy; HLFPPT.</p>
            <p>Designed & Developed by
                <a href="javascript:void(0);" class="text-primary">Duplex Services & Technology</a>
            </p>
        </footer>
    </div>

    <script>
        document.getElementById('editProjectForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const projectId = "<%= project._id %>";
            const data = {};
            const fields = ['projectName', 'projectCode', 'projectType', 'projectManager', 'department', 'projectStartDate', 'projectEndDate', 'projectDescription'];

            fields.forEach(field => {
                const value = this[field]?.value;
                if (value) { // only include non-empty fields
                    data[field] = value;
                }
            });

            try {
                const res = await fetch(`/api/projects/${projectId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await res.json();

                if (result.success) {
                    alert('Project updated successfully');
                    window.location.href = `/projects/${projectId}/project-details`;
                } else {
                    alert('Update failed: ' + result.message);
                }
            } catch (err) {
                console.error("Error updating project:", err);
                alert('Something went wrong');
            }
        });
    </script>

    <%- include('../../partials/footer') %>