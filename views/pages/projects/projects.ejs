<%- include('../../partials/header') %>
    <!-- Page Wrapper -->
    <div class="page-wrapper">
        <div class="content">
            <!-- Breadcrumb -->
            <div class="d-flex align-items-center justify-content-between page-breadcrumb mb-3">
                <div class="my-auto mb-2">
                    <h2 class="mb-1">Projects</h2>
                    <nav>
                        <ol class="breadcrumb mb-0">
                            <li class="breadcrumb-item">
                                <a href="#"><i class="ti ti-smart-home"></i></a>
                            </li>
                            <li class="breadcrumb-item">
                                Project List
                            </li>
                        </ol>
                    </nav>
                </div>

                <div class="rtbtn d-flex flex-column align-items-end mb-2">
                    <form action="/api/projects/sync" method="POST" id="sync-form" class="d-inline mb-1">
                        <button type="submit" id="sync-button" class="btn btn-primary btn-md">
                            <i class="ti ti-sync me-1"></i> Sync Now
                        </button>
                    </form>
                    <small class="text-muted">
                        Last sync: <span id="last-sync-time">
                            <%= new Date().toLocaleString() %>
                        </span>
                    </small>
                </div>
            </div>
            <!-- /Breadcrumb -->

            <div class="project_wpr">
                <div class="prjsrch_row mb-5">
                    <i class="ti ti-search"></i>
                    <input type="text" class="form-control simplesrchbox" placeholder="Type in here..."
                        name="searchproject">
                </div>
                <div class="row projct_cardswrp" id="projectContainer">
                </div>
            </div>

        </div>

        <div class="footer mt-4 d-sm-flex align-items-center justify-content-between border-top bg-white p-3">
            <p class="mb-0">2025 &copy; HLFPPT.</p>
            <p>Designed & Developed by <a href="javascript:void(0);" class="text-primary">Duplex services &
                    Technology</a>
            </p>
        </div>

    </div>
    <!-- /Page Wrapper -->
    <%- include('../../partials/footer') %>
        <script>

            function loadProjects(search = '') {
                $.ajax({
                    url: '/api/projects',
                    method: 'GET',
                    data: {
                        status: 'Active',
                        page: 1,
                        limit: 10,
                        search: search
                    },
                    xhrFields: {
                        withCredentials: true
                    },
                    success: function (response) {
                        if (response.success) {
                            let projects = response.data.projects;
                            let html = '';

                            if (projects.length > 0) {
                                projects.forEach(project => {
                                    html += `
                            <div class="col-sm-3">
                                <div class="card projectcard">
                                    <div class="card-body">
                                        <h5 class="fs-20 fw-normal mb-2">${project.title}</h5>
                                        <h6 class="fs-16 fw-normal text-neutral">
                                            Department: ${project.manager_list.map(m => m.emp_name).join(', ')}
                                        </h6>
                                        <small class="fs-12 text-black fw-light">
                                            Created on: ${new Date(project.add_date).toLocaleDateString('en-US', { day: '2-digit', month: 'long', year: 'numeric' })}
                                        </small>
                                        <h6 class="fs-16 fw-normal mt-2 text-neutral">
                                            In Charge: ${project.in_charge_list.map(i => i.emp_name).join(', ')}
                                        </h6>
                                        <div class="prjtxt mt-3">
                                            <p class="fs-12 fw-light">Duration: ${project.duration} | Status: ${project.status}</p>
                                            <div class="dflexbtwn">
                                                <a href="project-files.php?project_id=${project.project_id}" class="site-btnmd fw-light fs-12">Access Files</a>
                                                <span>0 Files</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            `;
                                });
                            } else {
                                html = `<div class="col-12"><p class="text-center">No projects found.</p></div>`;
                            }

                            $('#projectContainer').html(html);
                        }
                    },
                    error: function (err) {
                        console.error('Error fetching projects:', err);
                        $('#projectContainer').html(`<div class="col-12"><p class="text-center text-danger">Failed to load projects.</p></div>`);
                    }
                });
            }


            $(document).ready(function () {

                // Initial load
                loadProjects();

                let debounceTimer;
                $('.simplesrchbox').on('input', function () {
                    clearTimeout(debounceTimer);
                    let searchText = $(this).val();
                    debounceTimer = setTimeout(() => {
                        loadProjects(searchText);
                    }, 300); // delay 300ms to reduce frequent API calls
                });

            });
        </script>