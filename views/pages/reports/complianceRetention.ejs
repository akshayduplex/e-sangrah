<%- include('../../partials/header') %>

    <!-- Page Wrapper -->
    <div class="page-wrapper">
        <div class="content container-fluid">
            <!-- Breadcrumb -->
            <div class="d-md-flex d-block align-items-center justify-content-between page-breadcrumb mb-3">
                <div class="my-auto mb-2">
                    <h2 class="mb-1">Compliance and Retention</h2>
                    <nav>
                        <ol class="breadcrumb mb-0">
                            <li class="breadcrumb-item"><a href="#"><i class="ti ti-smart-home"></i></a></li>
                            <li class="breadcrumb-item">User Management</li>
                            <li class="breadcrumb-item">Reports</li>
                            <li class="breadcrumb-item active" aria-current="page">Compliance and Retention</li>
                        </ol>
                    </nav>
                </div>
            </div>
            <!-- /Breadcrumb -->

            <div class="row">
                <div class="seprate_crdhdr mb-3">
                    <div class="d-flex justify-content-end mb-3 gap-3 flex-wrap">
                        <!-- Department Select -->
                        <div class="me-2">
                            <select id="compilanceDepartment" class="form-select fs-13 select2">
                                <option value="">-- Select Department --</option>
                            </select>
                        </div>
                        <!-- Date Picker -->
                        <div class="input-icon-end position-relative">
                            <input type="text" class="form-control datetimepicker" placeholder="Select Date">
                            <span class="input-icon-addon"><i class="ti ti-calendar text-gray-7"></i></span>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-nowrap mb-0" id="documentsTable">
                                <thead>
                                    <tr>
                                        <th></th>
                                        <th>File Name</th>
                                        <th>Department</th>
                                        <th>Compliance</th>
                                        <th>Retention</th>
                                        <th>Expiry Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="footer d-sm-flex align-items-center justify-content-between border-top bg-white p-3 mt-4">
                <p class="mb-0">2025 &copy; HLFPPT.</p>
                <p>Designed & Developed by <a href="javascript:void(0);" class="text-primary">Duplex services &
                        Technology</a></p>
            </div>
        </div>
    </div>
    <%- include('../../partials/footer') %>
        <!-- Scripts -->
        <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
        <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
        <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
        <script>
            // ====================== File Type Icons ======================
            const fileIcons = {
                ppt: "/img/icons/fn1.png",
                pptx: "/img/icons/fn1.png",
                doc: "/img/icons/fn2.png",
                docx: "/img/icons/fn2.png",
                xls: "/img/icons/fn3.png",
                xlsx: "/img/icons/fn3.png",
                pdf: "/img/icons/fn4.png",
                jpg: "/img/icons/fn5.png",
                jpeg: "/img/icons/fn5.png",
                png: "/img/icons/fn5.png",
                gif: "/img/icons/fn5.png",
                default: "/img/icons/fn1.png"
            };

            // ====================== Helper Functions ======================
            function getFileIcon(fileName) {
                if (!fileName) return fileIcons.default;
                const ext = fileName.split('.').pop().toLowerCase();
                return fileIcons[ext] || fileIcons.default;
            }

            function formatFileSize(bytes) {
                if (!bytes || bytes === 0) return '—';
                if (bytes < 1024) return bytes + ' B';
                if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
                return (bytes / (1024 * 1024 * 1024)).toFixed(1) + ' GB';
            }

            function formatDateTime(iso) {
                if (!iso) return 'N/A';
                const date = new Date(iso);
                return date.toLocaleDateString('en-GB', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text || '';
                return div.innerHTML;
            }

            function getRetentionStatus(archivedAt, expiryDate) {
                if (archivedAt) {
                    return { status: "Archived", icon: `<i class="ti ti-archive text-warning"></i>` };
                }
                if (expiryDate && new Date(expiryDate) < new Date()) {
                    return { status: "Expired", icon: `<i class="ti ti-alert-circle text-danger"></i>` };
                }
                return { status: "Active", icon: `<i class="ti ti-circle-check text-success"></i>` };
            }

            // ====================== Dashboard Stats ======================
            async function loadDashboardStats(filter = 'year') {
                try {
                    const response = await fetch(`/api/dashboard/stats?filter=${filter}`);
                    const result = await response.json();
                    if (result.success) {
                        const stats = result.data;
                        document.getElementById('pendingCount').innerText = stats.pending || 0;
                        document.getElementById('approvedCount').innerText = stats.approved || 0;
                        document.getElementById('rejectedCount').innerText = stats.rejected || 0;
                    }
                } catch (error) {
                    console.error('Error loading dashboard stats:', error);
                }
            }

            // ====================== File Status Logs ======================
            async function loadFileStatusLogs() {
                const tableBody = document.getElementById('fileStatusTableBody');
                tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4"><div class="spinner-border spinner-border-sm"></div> Loading...</td></tr>`;

                try {
                    const response = await fetch('/api/permission-logs');
                    const result = await response.json();

                    if (result.success && Array.isArray(result.data) && result.data.length > 0) {
                        const rows = result.data.map(entry => {
                            const user = entry.user?.name || entry.user?.username || "Unknown User";
                            const fileObj = entry.document?.files?.[0] || {};
                            const fileName = fileObj.originalName || "Untitled File";
                            const fileSize = formatFileSize(fileObj.fileSize);
                            const icon = getFileIcon(fileName);
                            const action = entry.requestStatus || "Pending";
                            const date = formatDateTime(entry.requestedAt || entry.createdAt);

                            return `
                    <tr>
                        <td><p class="mb-0">${escapeHtml(user)}</p></td>
                        <td>
                            <div class="flxtblleft">
                                <span class="avatar rounded bg-light">
                                    <img src="${icon}" alt="icon">
                                </span>
                                <div class="flxtbltxt">
                                    <p class="fs-14 mb-1 fw-normal text-neutral text-truncate" style="max-width: 180px;">${escapeHtml(fileName)}</p>
                                    <span class="fs-11 text-muted">${fileSize}</span>
                                </div>
                            </div>
                        </td>
                        <td><p class="mb-0 tbl_date">${date}</p></td>
                        <td>
                            <span class="badge ${action === 'Approved' ? 'bg-success' : action === 'Rejected' ? 'bg-danger' : 'bg-warning'}">
                                ${action}
                            </span>
                        </td>
                    </tr>`;
                        }).join('');

                        tableBody.innerHTML = rows;
                    } else {
                        tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-muted">No activity logs found</td></tr>`;
                    }
                } catch (error) {
                    console.error('Error loading logs:', error);
                    tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-danger">Failed to load logs</td></tr>`;
                }
            }

            // ====================== Main: Load Documents Table ======================
            async function loadDocuments(selectedDept = "", sortBy = "") {
                const tbody = document.querySelector("#documentsTable tbody");
                tbody.innerHTML = `<tr><td colspan="6" class="text-center py-4"><div class="spinner-border"></div> Loading documents...</td></tr>`;

                try {
                    let url = `/api/documents/compliance?limit=10&page=1`;
                    if (selectedDept && selectedDept !== "all") url += `&department=${selectedDept}`;
                    if (sortBy) {
                        if (sortBy === "name") url += `&sort=metadata.fileName&order=asc`;
                        if (sortBy === "date") url += `&sort=createdAt&order=desc`;
                        if (sortBy === "status") url += `&sort=status&order=asc`;
                    }

                    const response = await fetch(url);
                    const result = await response.json();

                    if (!result.success || !result.data?.documents?.length) {
                        tbody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-muted">No documents found</td></tr>`;
                        return;
                    }

                    tbody.innerHTML = ""; // Clear loading

                    result.data.documents.forEach(doc => {
                        const { _id, metadata, department, compliance, files = [], isArchived, archivedAt } = doc;

                        const displayName = metadata?.fileName?.trim() || 'Untitled Document';
                        const deptName = department?.name || '—';

                        // Get latest version file
                        const latestFile = files.length > 0
                            ? files.reduce((a, b) => {
                                const verA = parseFloat(a.version?.$numberDecimal || a.version || 0);
                                const verB = parseFloat(b.version?.$numberDecimal || b.version || 0);
                                return verA > verB ? a : b;
                            })
                            : { originalName: '', fileSize: 0, version: { $numberDecimal: '1.0' } };

                        const fileName = latestFile.originalName || 'No file';
                        const fileSize = formatFileSize(latestFile.fileSize);
                        const version = latestFile.version?.$numberDecimal || latestFile.version || '1.0';
                        const fileIcon = getFileIcon(fileName);

                        // Compliance
                        const isCompliant = !!compliance?.isCompliance;
                        const expiryDate = compliance?.expiryDate ? new Date(compliance.expiryDate) : null;
                        const expiryText = expiryDate ? formatDateTime(expiryDate) : 'N/A';

                        // Retention Status
                        const retention = getRetentionStatus(archivedAt, compliance?.expiryDate);

                        // Compliance Badge
                        const complianceBadge = isCompliant
                            ? `<p class="text-success d-flex align-items-center gap-2 mb-0">
                        <span class="d-inline-flex align-items-center justify-content-center rounded-circle bg-success-subtle" style="width: 28px; height: 28px;">
                            <i class="ti ti-check"></i>
                        </span>
                        Compliant
                   </p>`
                            : `<p class="text-danger d-flex align-items-center gap-2 mb-0">
                        <span class="d-inline-flex align-items-center justify-content-center rounded-circle bg-danger-subtle" style="width: 28px; height: 28px;">
                            <i class="ti ti-x"></i>
                        </span>
                        Non-Compliant
                   </p>`;

                        // Actions Dropdown
                        const actionsDropdown = `
                <div class="btn-group" role="group">
                    <button type="button" class="btn border-0 p-1" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="ti ti-dots-vertical fs-18"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="/documents/${_id}/view"><i class="ti ti-eye"></i> View</a></li>
                        <li><a class="dropdown-item" href="/documents/edit/${_id}"><i class="ti ti-pencil"></i> Edit</a></li>
                        <li><a class="dropdown-item share-btn" href="#" data-doc-id="${_id}" data-bs-toggle="modal" data-bs-target="#sharedoc-modal"><i class="ti ti-share"></i> Share</a></li>
                        <li><a class="dropdown-item" href="#" data-id="${_id}" data-bs-toggle="modal" data-bs-target="#versionhistory-modal"><i class="ti ti-history"></i> Version History</a></li>
                        <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#downloaddoc-modal"><i class="ti ti-download"></i> Download</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-warning archive-document" href="#" data-id="${_id}" data-bs-toggle="modal" data-bs-target="#archivedoc-modal"><i class="ti ti-archive"></i> Archive</a></li>
                        <li><a class="dropdown-item text-danger btn-delete" href="#" data-id="${_id}" data-bs-toggle="modal" data-bs-target="#trashdoc-modal"><i class="ti ti-trash"></i> Move to Trash</a></li>
                    </ul>
                </div>`;

                        const rowHTML = `
                <tr data-doc-id="${_id}">
                    <td>${actionsDropdown}</td>
                    <td>
                        <div class="flxtblleft">
                            <span class="avatar rounded bg-light">
                                <img src="${fileIcon}" alt="icon" style="width: 32px; height: 32px; object-fit: contain;">
                            </span>
                            <div class="flxtbltxt">
                                <p class="fs-14 mb-1 fw-medium text-neutral text-truncate" style="max-width: 220px;" title="${escapeHtml(displayName)}">
                                    ${escapeHtml(displayName)}
                                    <span class="text-success ms-1">v${version}</span>
                                </p>
                                <span class="fs-11 text-muted">${fileSize}</span>
                            </div>
                        </div>
                    </td>
                    <td><p class="mb-0">${escapeHtml(deptName)}</p></td>
                    <td>${complianceBadge}</td>
                    <td>
                        <p class="mb-0 d-flex align-items-center gap-1 fw-medium text-neutral">
                            ${retention.icon} ${retention.status}
                        </p>
                    </td>
                    <td><p class="mb-0 tbl_date">${expiryText}</p></td>
                </tr>`;

                        tbody.insertAdjacentHTML('beforeend', rowHTML);
                    });

                    // Optional: Show total count
                    const total = result.data.pagination?.totalDocuments || 0;
                    const countEl = document.getElementById('totalDocumentsCount');
                    if (countEl) countEl.textContent = total;

                } catch (err) {
                    console.error("Error loading documents:", err);
                    tbody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-danger">Failed to load documents</td></tr>`;
                }
            }

            // ====================== Analytics & Charts (Optional) ======================
            async function loadAnalyticsStats() {
                try {
                    const res = await fetch("/api/analytics/stats");
                    const { data } = await res.json();
                    document.querySelector("#total-documents").textContent = data.totalDocuments || 0;
                    document.querySelector("#uploaded-this-month").textContent = data.uploadedThisMonth || 0;
                    document.querySelector("#modified-documents").textContent = data.modifiedDocuments || 0;
                    document.querySelector("#deleted-archive").textContent = data.deletedOrArchived || 0;
                } catch (err) {
                    console.error("Failed to load analytics:", err);
                }
            }

            async function loadFileUsage() {
                try {
                    const res = await fetch('/api/analytics/department-file-usage');
                    const data = await res.json();
                    if (data.categories && data.series) {
                        Highcharts.chart('fileUsageChart', {
                            chart: { type: 'line' },
                            title: { text: null },
                            xAxis: { categories: data.categories },
                            yAxis: { title: { text: null } },
                            series: data.series,
                            credits: { enabled: false },
                            legend: { enabled: true }
                        });
                    }
                } catch (error) {
                    console.error("Chart error:", error);
                }
            }

            // ====================== DOM Ready ======================
            document.addEventListener('DOMContentLoaded', () => {
                let currentDept = "";
                let currentSort = "";

                // Department Filter
                const deptSelect = document.getElementById("analyticsDepartment");
                if (deptSelect) {
                    deptSelect.addEventListener("change", function () {
                        currentDept = this.value;
                        loadDocuments(currentDept, currentSort);
                    });
                }

                // Sort Filter
                const sortSelect = document.getElementById("sortBySelect");
                if (sortSelect) {
                    sortSelect.addEventListener("change", function () {
                        currentSort = this.value;
                        loadDocuments(currentDept, currentSort);
                    });
                }

                // Initial Loads
                loadDashboardStats();
                loadFileStatusLogs();
                loadDocuments();
                loadAnalyticsStats();
                loadFileUsage();

                // Optional: Filter range change
                document.getElementById('filterRange')?.addEventListener('change', (e) => {
                    loadDashboardStats(e.target.value);
                });
            });
        </script>
        <script src="/js/components/shareDocument.js"></script>