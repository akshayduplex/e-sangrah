<!-- Add Todo -->
<div class="modal fade" id="add_todo">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Add New Todo</h4>
                <button type="button" class="btn-close custom-btn-close" data-bs-dismiss="modal" aria-label="Close">
                    <i class="ti ti-x"></i>
                </button>
            </div>
            <form action="https://smarthr.co.in/demo/html/template/index.html">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-12">
                            <div class="mb-3">
                                <label class="form-label">Todo Title</label>
                                <input type="text" class="form-control">
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="mb-3">
                                <label class="form-label">Tag</label>
                                <select class="select">
                                    <option>Select</option>
                                    <option>Internal</option>
                                    <option>Projects</option>
                                    <option>Meetings</option>
                                    <option>Reminder</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="mb-3">
                                <label class="form-label">Priority</label>
                                <select class="select">
                                    <option>Select</option>
                                    <option>Medium</option>
                                    <option>High</option>
                                    <option>Low</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-lg-12">
                            <div class="mb-3">
                                <label class="form-label">Descriptions</label>
                                <div class="summernote"></div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="mb-3">
                                <label class="form-label">Add Assignee</label>
                                <select class="select">
                                    <option>Select</option>
                                    <option>Sophie</option>
                                    <option>Cameron</option>
                                    <option>Doris</option>
                                    <option>Rufana</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="mb-0">
                                <label class="form-label">Status</label>
                                <select class="select">
                                    <option>Select</option>
                                    <option>Completed</option>
                                    <option>Pending</option>
                                    <option>Onhold</option>
                                    <option>Inprogress</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light me-2" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add New Todo</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- /Add Todo -->

<!-- Add Leaves -->
<div class="modal fade" id="add_leaves">
    <div class="modal-dialog modal-dialog-centered modal-md">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Add Leave Request</h4>
                <button type="button" class="btn-close custom-btn-close" data-bs-dismiss="modal" aria-label="Close">
                    <i class="ti ti-x"></i>
                </button>
            </div>
            <form action="https://smarthr.co.in/demo/html/template/index.html">
                <div class="modal-body pb-0">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label class="form-label">Employee Name</label>
                                <select class="select">
                                    <option>Select</option>
                                    <option>Anthony Lewis</option>
                                    <option>Brian Villalobos</option>
                                    <option>Harvey Smith</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label class="form-label">Leave Type</label>
                                <select class="select">
                                    <option>Select</option>
                                    <option>Medical Leave</option>
                                    <option>Casual Leave</option>
                                    <option>Annual Leave</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">From </label>
                                <div class="input-icon-end position-relative">
                                    <input type="text" class="form-control datetimepicker" placeholder="dd/mm/yyyy">
                                    <span class="input-icon-addon">
                                        <i class="ti ti-calendar text-gray-7"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">To </label>
                                <div class="input-icon-end position-relative">
                                    <input type="text" class="form-control datetimepicker" placeholder="dd/mm/yyyy">
                                    <span class="input-icon-addon">
                                        <i class="ti ti-calendar text-gray-7"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">No of Days</label>
                                <input type="text" class="form-control" disabled>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Remaining Days</label>
                                <input type="text" class="form-control" disabled>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label class="form-label">Reason</label>
                                <textarea class="form-control" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light me-2" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Leaves</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- /Add Leaves -->

</div>
<!-- /Main Wrapper -->

<!-- jQuery -->
<!-- <script data-cfasync="false" src="../../../cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script> -->
<script src="/js/jquery-3.7.1.min.js"></script>
<!-- <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet"> -->
<!-- Bootstrap Core JS -->
<script src="/js/bootstrap.bundle.min.js"></script>

<!-- Feather Icon JS -->
<script src="/js/feather.min.js"></script>

<!-- Slimscroll JS -->
<script src="/js/jquery.slimscroll.min.js"></script>
<!-- Chart JS -->
<script src="/plugins/apexchart/apexcharts.min.js"></script>
<script src="/plugins/apexchart/chart-data.js"></script>

<!-- Chart JS -->
<script src="/plugins/chartjs/chart.min.js"></script>
<script src="/plugins/chartjs/chart-data.js"></script>

<!-- Datetimepicker JS -->
<script src="/js/moment.min.js"></script>
<script src="/js/bootstrap-datetimepicker.min.js"></script>

<!-- Daterangepikcer JS -->
<script src="/plugins/daterangepicker/daterangepicker.js"></script>

<!-- Summernote JS -->
<script src="/plugins/summernote/summernote-lite.min.js"></script>

<!-- Bootstrap Tagsinput JS -->
<script src="/plugins/bootstrap-tagsinput/bootstrap-tagsinput.js"></script>

<!-- Select2 JS -->
<script src="/plugins/select2/js/select2.min.js"></script>

<!-- Color Picker JS -->
<script src="/plugins/%40simonwep/pickr/pickr.es5.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<!-- <script src="/socket.io/socket.io.js"></script> -->

<!-- Custom JS -->
<script> window.baseUrl = "<%= BASE_URL %>";</script>
<script src="/js/todo.js"></script>
<script src="/js/toast.js"></script>
<script defer src="/js/components/header.js"></script>
<script src="/js/components/formatDate.js"></script>
<script src="/js/theme-colorpicker.js"></script>
<script src="/js/script.js"></script>
<script src="/js/components/sidebar.js"></script>
<!-- <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> -->
<script src="/js/utils.js"></script>
<script src="/js/pages/login.js"></script>
<script scr="/js/pages/projectList.js"></script>
<script src="/js/utils/constant.js"></script>

<!-- Share Document Modal -->
<div class="modal fade" id="sharedoc-modal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content custom-modal p-3">
            <div class="modal-header">
                <div class="mdhhdng_subhdng">
                    <h5 class="modal-title fw-bold">Share Document</h5>
                    <p>Invite the members to collaborate in this document</p>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <!-- Time Duration -->
                <h6 class="fw-normal fs-20 mb-3">Time Duration</h6>
                <div class="d-flex flex-wrap gap-3 mb-4">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="time" id="oneday">
                        <label class="form-check-label" for="oneday">One Day</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="time" id="onemonth">
                        <label class="form-check-label" for="onemonth">1 Month</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="time" id="oneweek">
                        <label class="form-check-label" for="oneweek">1 Week</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="time" id="lifetime">
                        <label class="form-check-label" for="lifetime">Lifetime</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="time" id="onetime">
                        <label class="form-check-label" for="onetime">One Time</label>
                    </div>
                    <div class="form-check position-relative">
                        <input class="form-check-input" type="radio" name="time" id="custom">
                        <label class="form-check-label rangelabel" for="custom">Custom <i
                                class="ti ti-calendar"></i></label>
                        <div id="customDateWrapper" style="display:none;">
                            <input type="text" class="form-control" placeholder="YYYY-MM-DD to YYYY-MM-DD"
                                id="flatpickr-range" />
                        </div>
                    </div>
                </div>

                <!-- Search User -->
                <div class="d-flex mb-4 gap-2">
                    <select id="userInviteSelect" class="form-select" style="width: 200px;"></select>
                    <select class="form-select" id="accessLevelSelect" style="width: 140px;">
                        <option value="view">View Only</option>
                        <option value="edit">Edit</option>
                    </select>
                    <button id="inviteUserBtn" class="site-btnmd">Invite</button>
                </div>

                <!-- People With Access -->
                <h6 class="fw-normal fs-20 mb-3">People With Access</h6>
                <div id="usersWithAccessContainer" class="mb-4"></div>

                <!-- General Access -->
                <h6 class="fw-normal fs-20 mb-3">General Access</h6>
                <div class="d-flex align-items-start justify-content-between mb-4">
                    <div class="icon_anyoneslct d-flex align-items-center gap-2">
                        <div class="icn">
                            <img src="/img/icons/link.png" alt="link icon">
                        </div>
                        <div class="anyone_txtwrp">
                            <select id="accessType" class="form-select w-auto mb-1">
                                <option value="anyone" selected>Anyone with the link</option>
                                <option value="restricted">Restricted</option>
                            </select>
                            <small class="fs-12" id="infoText">Anyone on the internet with the link can view</small>
                        </div>
                    </div>
                    <select id="roleType" class="form-select form-select-sm" style="width:120px;">
                        <option value="viewer" selected>Can View</option>
                        <option value="editor">Can Edit</option>
                    </select>
                </div>

                <!-- Share Link -->
                <div class="input-group mb-3 copygroup">
                    <input type="text" id="sharelink" class="form-control copygroup" style="max-width: 87%"
                        value="https://duplextech.com/" readonly>
                    <button class="btn btncopylink" id="copyLinkBtn">
                        <i class="ti ti-copy"></i> <span>Copy link</span>
                    </button>
                </div>
            </div>

            <div class="modal-footer">
                <button class="site-btnmd" id="shareBtn">Done</button>
            </div>
        </div>
    </div>
</div>

<!-- Version modal -->
<div class="modal fade" id="versionhistory-modal" tabindex="-1" aria-labelledby="versionHistoryModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="versionHistoryModalLabel">Version History</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="search-bar mb-3">
                    <input type="text" class="form-control" placeholder="Search Version History" id="versionSearch">
                </div>
                <div class="version-list" id="versionListContainer">
                    <!-- Dynamic content will be loaded here -->
                    <div class="text-center py-4">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Download modal -->

<div class="modal fade" id="downloaddoc-modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius:20px;">

            <!-- Header -->
            <div class="modal-header border-0">
                <h5 class="modal-title fw-medium fs-24 text-black" id="downloadModalTitle">
                    Download File
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <!-- Body -->
            <div class="modal-body">
                <div class="border rounded-3 p-3 d-flex">

                    <!-- File Icon -->
                    <span class="avatar avatar-xxxl rounded bg-light mb-2 p-2 me-4">
                        <img src="/img/icons/fn2big.png" id="downloadFileIcon">
                    </span>

                    <!-- File Info -->
                    <div class="flex-grow-1">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" name="fileOption" id="originalFile" checked>
                            <label class="form-check-label" for="originalFile" id="downloadFileLabel">
                                Original File <span class="text-muted d-block" id="downloadFileSize">(—)</span>
                            </label>
                        </div>
                        <button id="confirmDownload" class="btn btn-primary px-4 fw-normal rounded-pill">
                            Download
                        </button>
                    </div>

                </div>
            </div>

        </div>
    </div>
</div>


<!-- Thrashdoc modal -->

<div class="modal fade" id="trashdoc-modal" tabindex="-1" aria-labelledby="trashdocLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow p-3">
            <!-- Header -->
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold" id="trashdocLabel">
                    <img src="/img/icons/bin.png"> <br>
                    Move to Recycle Bin
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Body -->
            <div class="modal-body text-muted">
                Please confirm that you want to move the selected item(s) to the Recycle bin
            </div>

            <!-- Footer -->
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light px-4 rounded-pill" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirm-trash-folder" class="btn btn-primary px-4 rounded-pill">Yes,
                    Move</button>
            </div>
        </div>
    </div>
</div>


<!-- Restore Modal -->
<div class="modal fade" id="restore-folder-modal" tabindex="-1" aria-labelledby="restoreFolderLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow p-3">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold d-flex align-items-center" id="restoreFolderLabel">
                    <img src="/img/icons/restore.png" alt="Restore Icon" width="32" class="me-2">
                    Restore Folder
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-muted">
                Are you sure you want to restore this folder?
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light px-4 rounded-pill" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirm-restore-folder" class="btn btn-success px-4 rounded-pill">Yes,
                    Restore</button>
            </div>
        </div>
    </div>
</div>

<!-- Archivedoc modal -->

<div class="modal fade" id="archivedoc-modal" tabindex="-1" aria-labelledby="archivedocLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow p-3">
            <!-- Header -->
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold" id="archivedocLabel">
                    <img class="" src="/img/icons/archvbin.png"> <br>
                    Move to Archive
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Body -->
            <div class="modal-body text-muted">
                Are you sure you want to archive Proposal v2.4 ?
            </div>

            <!-- Footer -->
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light px-4 rounded-pill" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" id="confirm-archive-folder" class="btn btn-primary px-4 rounded-pill">Yes,
                    Move</button>
            </div>
        </div>
    </div>
</div>

<!-- Folder Creation Modal -->
<div id="folder-modal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            <div class="modal-body">
                <h5>Create New Folder</h5>
                <form id="createFolderForm" class="mt-4 px-3">
                    <div class="mb-3">
                        <label for="folderName" class="form-label">Folder Name</label>
                        <input class="form-control" type="text" id="folderName" name="name" required
                            placeholder="Enter Folder Name">
                    </div>
                    <div class="mb-3">
                        <label for="parentFolder" class="form-label">Parent Folder</label>
                        <select id="parentFolder" class="form-control select2" style="width: 100%;">
                            <option value="">-- Root (No Parent) --</option>
                        </select>
                    </div>
                    <div class="mb-3 text-center">
                        <button class="btn btn-primary rounded-pill" type="submit">Create Folder</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!--Recyclbin all delete files modal  -->
<div class="modal fade" id="emptybin-modal" tabindex="-1" aria-labelledby="emptybinLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-md">
        <div class="modal-content rounded-4 shadow p-3">
            <div class="modal-header d-block border-0 pb-0">
                <img class="mb-3" src="/img/icons/bin.png">
                <h5 class="modal-title fw-bold" id="trashdocLabel">
                    Emptying the Recycle Bin
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Body -->
            <div class="modal-body text-muted" id="emptybin-modal-body">
                Are you sure you want to permanently
                <span class="txtblue">delete all files</span> in the recycle bin
                (<span id="recyclebin-size">0MB</span>)?
                This action cannot be undone.
            </div>

            <!-- Footer -->
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light px-4 rounded-pill" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" id="confirm-empty-bin" class="btn btn-primary px-4 rounded-pill">
                    Yes, Delete
                </button>
            </div>
        </div>
    </div>
</div>

<!--Recyclbin single delete file modal  -->
<div class="modal fade" id="fileDelete-modal" tabindex="-1" aria-labelledby="fileDeleteLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-md">
        <div class="modal-content rounded-4 shadow p-3">

            <!-- Header -->
            <div class="modal-header d-flex align-items-center justify-content-between border-0 pb-0">
                <div class="d-flex align-items-center">
                    <img class="me-3" src="/img/icons/bin.png" alt="Bin Icon">

                    <div class="d-flex align-items-center">
                        <span class="avatar rounded bg-light me-2">
                            <img src="/img/icons/fn1.png" alt="File Icon">
                        </span>
                        <div class="flxtbltxt">
                            <p class="fs-14 mb-1 fw-normal text-neutral">
                                Project Proposal v1
                                <span class="text-success">+2</span>
                            </p>
                            <span class="fs-11 fw-light text-black">190KB</span>
                        </div>
                    </div>
                </div>

                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Body -->
            <h5 class="mt-3">
                Are you sure you want to permanently delete this file?
            </h5>
            <div class="modal-body text-muted">
                Once the file is deleted from the recycle bin it cannot be retrieved.
            </div>

            <!-- Footer -->
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light px-4 rounded-pill" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary px-4 rounded-pill">Delete Permanently</button>
            </div>
        </div>
    </div>
</div>



<!--Restore files modal  -->
<div class="modal fade" id="restore-modal" tabindex="-1" aria-labelledby="restoremodalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-md">
        <div class="modal-content rounded-4 shadow p-3">

            <!-- Header -->
            <div class="modal-header d-flex align-items-center justify-content-between border-0 pb-0">
                <div class="d-flex align-items-center">
                    <img class="me-3" src="/img/icons/bin.png" alt="Restore Icon">

                    <div class="d-flex align-items-center">
                        <span class="avatar rounded bg-light me-2">
                            <img src="/img/icons/fn1.png" alt="File Icon">
                        </span>
                        <div class="flxtbltxt">
                            <p class="fs-14 mb-1 fw-normal text-neutral">
                                <span id="restore-file-name">Project Proposal v1</span>
                                <span id="restore-file-count" class="text-success">+2</span>
                            </p>
                            <span id="restore-file-size" class="fs-11 fw-light text-black">190KB</span>
                        </div>
                    </div>
                </div>

                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Body -->
            <h5 class="mt-3">Are you sure you want to restore this file?</h5>
            <div class="modal-body text-muted">
                The file will be restored to its original destination.
            </div>

            <!-- Footer -->
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light px-4 rounded-pill" data-bs-dismiss="modal">Cancel</button>
                <button id="confirm-restore" type="button" class="btn btn-primary px-4 rounded-pill">
                    Yes, Restore
                </button>
            </div>

        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        document.addEventListener('hidden.bs.modal', () => {
            document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
            document.body.classList.remove('modal-open');
        });

        const $headerYearSelect = $('#selectHeaderYear');
        const $headerProjectSelect = $('#selectHeaderProject');

        // ---------------------------
        // YEAR SELECT FIX (with All)
        // ---------------------------
        if ($headerYearSelect.length) {
            const currentYear = new Date().getFullYear();
            const startYear = 1995;
            const endYear = currentYear;

            // Add “All” option first
            $headerYearSelect.append(new Option('All', 'all', false, false));

            // Populate dropdown
            for (let year = endYear; year >= startYear; year--) {
                $headerYearSelect.append(new Option(year, year, false, false));
            }

            // Initialize Select2
            $headerYearSelect.select2({
                placeholder: 'Select Year',
                allowClear: false,
            });

            // On change — save and reload
            $headerYearSelect.on('change', async function () {
                const selectedYear = $(this).val();

                try {
                    const res = await fetch(`${baseUrl}/api/session/project`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({
                            selectedYear: selectedYear === 'all' ? null : selectedYear,
                            projectId: window.selectedProjectId || null
                        })
                    });

                    if (!res.ok) throw new Error('Failed to save year selection');
                    location.reload();
                } catch (err) {
                    console.error('Error saving year selection:', err);
                }
            });

            // Load saved or default year
            (async function loadSavedYear() {
                try {
                    const res = await fetch(`${baseUrl}/api/session/project`, { credentials: 'include' });
                    const data = await res.json();
                    const savedYear = data.selectedYear ? data.selectedYear : 'all';

                    if (!$headerYearSelect.find(`option[value="${savedYear}"]`).length) {
                        $headerYearSelect.append(new Option(savedYear, savedYear, true, true));
                    }

                    $headerYearSelect.val(savedYear).trigger('change.select2');
                } catch (err) {
                    console.error('Error loading saved year:', err);
                }
            })();
        }

        // ---------------------------
        // PROJECT SELECT FIX (with “All Projects”)
        // ---------------------------
        if ($headerProjectSelect.length) {
            $headerProjectSelect.select2({
                placeholder: 'Select Project',
                allowClear: false,
                width: '250px',
                ajax: {
                    url: `${baseUrl}/api/projects`,
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return {
                            search: params.term || '',
                            page: params.page || 1,
                            limit: 10
                        };
                    },
                    processResults: function (data) {
                        // Map projects from API
                        const projects = (data.data || []).map(p => ({
                            id: p._id,
                            text: p.projectName || p.name
                        }));

                        // Always include “All Projects” at the top
                        return {
                            results: [
                                { id: 'all', text: 'All Projects' },
                                ...projects
                            ]
                        };
                    },
                    cache: true
                },
                // Ensure “All Projects” shows when loaded with no search
                templateSelection: function (data) {
                    return data.text || 'All Projects';
                }
            });

            // Save on select/unselect
            $headerProjectSelect.on('select2:select select2:unselect', async function () {
                const projectId = $(this).val();
                const projectName = $(this).find('option:selected').text();

                try {
                    const res = await fetch(`${baseUrl}/api/session/project`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({
                            projectId: projectId === 'all' ? null : projectId,
                            projectName: projectId === 'all' ? '' : projectName
                        })
                    });

                    if (!res.ok) throw new Error('Failed to save project selection');
                    location.reload();
                } catch (err) {
                    console.error('Error saving project selection:', err);
                }
            });

            // Load saved project from session
            (async function loadSavedProject() {
                try {
                    const res = await fetch(`${baseUrl}/api/session/project`, { credentials: 'include' });
                    const data = await res.json();

                    if (data.selectedProject) {
                        window.selectedProjectId = data.selectedProject;
                        window.selectedProjectName = data.selectedProjectName;

                        if (!$headerProjectSelect.find(`option[value="${data.selectedProject}"]`).length) {
                            const option = new Option(data.selectedProjectName, data.selectedProject, true, true);
                            $headerProjectSelect.append(option);
                        }

                        $headerProjectSelect.val(data.selectedProject).trigger('change.select2');
                    } else {
                        // Default to “All Projects”
                        const allOption = new Option('All Projects', 'all', true, true);
                        $headerProjectSelect.append(allOption).trigger('change.select2');
                    }
                } catch (err) {
                    console.error('Error loading saved project:', err);
                }
            })();
        }
    });
</script>



<script>
    (function ($) {
        "use strict";

        // Debounce utility
        function debounce(func, delay) {
            let timeout;
            return function () {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, arguments), delay);
            };
        }

        // Check if on documents list page
        function isOnDocumentsPage() {
            return window.location.pathname === '/documents/list' ||
                window.location.pathname.startsWith('/documents/list?');
        }

        // Get current status (from URL or default)
        function getCurrentStatus() {
            const params = new URLSearchParams(window.location.search);
            return params.get('status') || 'all';
        }

        // Update URL without reload
        function updateUrl(params) {
            const url = new URL(window.location);
            Object.keys(params).forEach(key => {
                if (params[key]) {
                    url.searchParams.set(key, params[key]);
                } else {
                    url.searchParams.delete(key);
                }
            });
            window.history.pushState({}, '', url);
        }

        // Redirect to documents with search
        function redirectToDocuments(searchTerm = '', status = 'all') {
            const params = new URLSearchParams();
            if (searchTerm) params.append('q', searchTerm);
            if (status && status !== 'all') params.append('status', status);
            window.location.href = `/documents/list?${params.toString()}`;
        }

        // Reload DataTable and sync URL
        function reloadTableWithSearch(searchTerm = '') {
            if (typeof table !== 'undefined' && table.ajax?.reload) {
                $('#searchInput').val(searchTerm);
                table.ajax.reload(null, false); // false = preserve paging

                updateUrl({ q: searchTerm || null });
            }
        }

        // Initialize search from URL
        function initSearchFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const q = params.get('q') || '';

            $('#globalSearchInput').val(q);
            if (isOnDocumentsPage() && $('#searchInput').length) {
                $('#searchInput').val(q);
            }

            toggleClearButtons();
        }

        // Toggle clear buttons visibility
        function toggleClearButtons() {
            $('.clear-search-global').toggle(!!$('#globalSearchInput').val().trim());
            $('.clear-search-page').toggle(!!$('#searchInput').val().trim());
        }

        // Clear search (both inputs + table + URL)
        function clearSearch() {
            $('#globalSearchInput, #searchInput').val('');
            toggleClearButtons();

            if (isOnDocumentsPage()) {
                updateUrl({ q: null });
                if (typeof table !== 'undefined') {
                    table.ajax.reload(null, false);
                }
            }
        }

        // === EVENT LISTENERS ===

        $(document).ready(function () {
            // Add clear button to page search input (if exists)
            if ($('#searchInput').length && $('#searchInput').closest('.position-relative').length === 0) {
                $('#searchInput').wrap('<div class="position-relative"></div>');
                $('#searchInput').parent().append(`
                    <button type="button" class="btn btn-sm btn-icon clear-search-page position-absolute end-0 top-50 translate-middle-y me-2"
                        style="display: none; z-index: 10;">
                        <i class="ti ti-x"></i>
                    </button>
                `);
            }

            initSearchFromUrl();

            // Global search form submit
            $('#globalSearchForm').on('submit', function (e) {
                e.preventDefault();
                const term = $('#globalSearchInput').val().trim();
                const status = getCurrentStatus();

                if (isOnDocumentsPage()) {
                    reloadTableWithSearch(term);
                } else {
                    redirectToDocuments(term, status);
                }
            });

            // Enter key in global input
            $('#globalSearchInput').on('keypress', function (e) {
                if (e.which === 13) {
                    $('#globalSearchForm').trigger('submit');
                }
            });

            // Live search on documents page (debounced)
            $('#searchInput').on('input', debounce(function () {
                if (isOnDocumentsPage()) {
                    const term = $(this).val().trim();
                    reloadTableWithSearch(term);
                }
            }, 500));

            // Clear button clicks
            $(document).on('click', '.clear-search-global', function () {
                clearSearch();
                $('#globalSearchForm').trigger('submit');
            });

            $(document).on('click', '.clear-search-page', function () {
                clearSearch();
                if (isOnDocumentsPage()) {
                    reloadTableWithSearch('');
                }
            });

            // Update clear buttons on input
            $('#globalSearchInput, #searchInput').on('input', toggleClearButtons);

            // Sync global input with page input on documents page
            $('#globalSearchInput').on('input', function () {
                if (isOnDocumentsPage()) {
                    const val = $(this).val();
                    $('#searchInput').val(val);
                    toggleClearButtons();
                }
            });
        });

    })(jQuery);
</script>
<script>
    $(document).ready(function () {
        const baseUrl = window.baseUrl;
        let currentDocId = null;

        // Initialize Select2
        $('#userInviteSelect').select2({
            placeholder: "Select user or enter email",
            allowClear: true,
            width: 'resolve', // respects the container width
            dropdownParent: $('#sharedoc-modal'), // ensures dropdown stays inside modal
            ajax: {
                url: `${baseUrl}/api/user/search`,
                dataType: 'json',
                delay: 250,
                data: params => ({ search: params.term }),
                processResults: data => ({
                    results: (data.users || []).map(u => ({
                        id: u.email,
                        text: `${u.name}`,
                        isNew: false
                    }))
                })
            },
            tags: true,
            createTag: function (params) {
                const email = params.term.trim();
                if (/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                    return { id: email, text: email, isNew: true };
                }
                return null;
            },
            minimumInputLength: 0
        });
    });
</script>

<script>
    document.querySelectorAll('input[name="time"]').forEach(radio => {
        radio.addEventListener('change', function () {
            if (this.id === "custom") {
                document.getElementById("customDateWrapper").style.display = "flex";
                document.getElementsByClassName("rangelabel")[0].style.display = "none";
            } else {
                document.getElementById("customDateWrapper").style.display = "none";
                document.getElementsByClassName("rangelabel")[0].style.display = "block";
            }
        });
    });

    const accessType = document.getElementById("accessType");
    const roleType = document.getElementById("roleType");

    accessType.addEventListener("change", function () {
        if (this.value === "anyone") {
            roleType.classList.remove("d-none"); // show role dropdown
            infoText.textContent = "Anyone on the internet with the link can view";
        } else {
            roleType.classList.add("d-none"); // hide role dropdown
            infoText.textContent = "Only people with access can open this link";
        }
    });


</script>

</body>

</html>